[{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\app\\page.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\components\\DatagridEditor.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Save' is defined but never used.","line":11,"column":21,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":25,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Save"},"fix":{"range":[449,455],"text":""},"desc":"Remove unused variable \"Save\"."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":215,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":215,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10850,10853],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10850,10853],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\n\"use client\"\r\n\r\nimport React from \"react\"\r\nimport { useSearchParams } from \"next/navigation\"\r\nimport { DataTable } from \"@/components/datagrid/data-table\"\r\nimport { columnsLab } from \"@/components/datagrid/columns\"\r\nimport { columnsComercial } from \"@/components/datagrid/columns-comercial\"\r\nimport { columnsAdmin } from \"@/components/datagrid/columns-admin\"\r\nimport { useProgramacionData } from \"@/hooks/use-programacion-data\"\r\nimport { RefreshCw, Save, Wifi, WifiOff, FileDown, Info, Lock } from \"lucide-react\"\r\nimport { LoginButton } from \"@/components/login-button\"\r\nimport { useCurrentUser } from \"@/hooks/use-current-user\"\r\n\r\nexport function DatagridEditor() {\r\n    const searchParams = useSearchParams()\r\n    const modeParam = searchParams.get('mode')\r\n    const { loading: authLoading, role, allowedViews, getCanView, getCanWrite, needsAuth, permissions } = useCurrentUser()\r\n\r\n    // Initialize state based on URL param, with role-based fallback\r\n    const roleParam = searchParams.get('role') || ''\r\n\r\n    // Map role_ids directly to views (based on database values)\r\n    const roleToViewMap: Record<string, \"LAB\" | \"COM\" | \"ADMIN\"> = {\r\n        'admin': 'ADMIN',\r\n        'administrativo': 'ADMIN',\r\n        'vendor': 'COM',\r\n        'laboratorio_lector': 'LAB',\r\n        'laboratorio_tipificador': 'LAB'\r\n    }\r\n\r\n    const [viewMode, setViewMode] = React.useState<\"LAB\" | \"COM\" | \"ADMIN\">(() => {\r\n        // First priority: explicit mode in URL\r\n        if (modeParam === 'comercial' || modeParam === 'com') {\r\n            return 'COM'\r\n        }\r\n        if (modeParam === 'admin') {\r\n            return 'ADMIN'\r\n        }\r\n        if (modeParam === 'lab' || modeParam === 'laboratorio') {\r\n            return 'LAB'\r\n        }\r\n\r\n        // Fallback: detect from role parameter using exact match\r\n        const rNorm = roleParam.toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n\r\n        if (roleToViewMap[rNorm]) {\r\n            return roleToViewMap[rNorm]\r\n        }\r\n\r\n        // Pattern matching fallback\r\n        if (rNorm.includes('admin') || rNorm.includes('geren') || rNorm.includes('direc') || rNorm.includes('jefe')) {\r\n            return 'ADMIN'\r\n        }\r\n        if (rNorm.includes('comercial') || rNorm.includes('vendedor') || rNorm.includes('asesor') || rNorm.includes('vendor') || rNorm.includes('ventas')) {\r\n            return 'COM'\r\n        }\r\n        return 'LAB'\r\n    })\r\n\r\n\r\n    const canWrite = React.useMemo(() => getCanWrite(viewMode), [viewMode, getCanWrite])\r\n\r\n    // Reactive sync with URL param (handles case where useState init misses it)\r\n    React.useEffect(() => {\r\n        if (modeParam === 'comercial' || modeParam === 'com') setViewMode('COM')\r\n        else if (modeParam === 'admin') setViewMode('ADMIN')\r\n        else if (modeParam === 'laboratorio' || modeParam === 'lab') setViewMode('LAB')\r\n    }, [modeParam])\r\n\r\n\r\n    // Enforce Permissions Logic: Sync view mode with allowed views\r\n    React.useEffect(() => {\r\n        if (!authLoading && !needsAuth && allowedViews.length > 0) {\r\n            // High-level role detection for bypass\r\n            const rNorm = (role || \"\").toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n            const isHighLevel = rNorm.includes(\"admin\") || rNorm.includes(\"geren\") || rNorm.includes(\"administra\") || rNorm.includes(\"direc\") || rNorm.includes(\"jefe\")\r\n\r\n            // Bypass security reset if we have high-level role or explicit permission\r\n            const hasAccess = isHighLevel || allowedViews.includes(viewMode)\r\n\r\n            if (!hasAccess) {\r\n                setViewMode(allowedViews[0])\r\n            }\r\n        }\r\n    }, [authLoading, needsAuth, allowedViews, viewMode, role])\r\n\r\n    const { data, isLoading, realtimeStatus, updateField, insertRow, exportToExcel } = useProgramacionData()\r\n\r\n    // Determine which columns to show based on view mode\r\n    const currentColumns = React.useMemo(() => {\r\n        if (viewMode === 'COM') return columnsComercial\r\n        if (viewMode === 'ADMIN') return columnsAdmin\r\n        return columnsLab\r\n    }, [viewMode])\r\n\r\n    // 1. Loading State\r\n    if (authLoading) {\r\n        return (\r\n            <div className=\"flex h-screen w-full items-center justify-center bg-zinc-50\">\r\n                <div className=\"flex flex-col items-center gap-2\">\r\n                    <RefreshCw className=\"w-8 h-8 text-blue-600 animate-spin\" />\r\n                    <span className=\"text-zinc-500 text-sm font-medium\">Verificando credenciales...</span>\r\n                </div>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    // 2. Auth Required State (Direct access protection)\r\n    if (needsAuth) {\r\n        return (\r\n            <div className=\"flex h-screen w-full flex-col items-center justify-center bg-zinc-50 p-4\">\r\n                <div className=\"w-full max-w-md bg-white rounded-xl shadow-xl border border-zinc-200 p-8 flex flex-col items-center text-center\">\r\n                    <div className=\"w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-6\">\r\n                        <Lock className=\"w-8 h-8 text-blue-600\" />\r\n                    </div>\r\n                    <h2 className=\"text-2xl font-bold text-zinc-900 mb-2\">Acceso Restringido</h2>\r\n                    <p className=\"text-zinc-500 mb-8 px-4\">\r\n                        Para visualizar o editar la programaci├│n, debes iniciar sesi├│n con tus credenciales de usuario.\r\n                    </p>\r\n                    <div className=\"w-full h-px bg-zinc-100 mb-8\" />\r\n                    <LoginButton />\r\n                    <p className=\"mt-6 text-[11px] text-zinc-400 uppercase tracking-widest font-semibold font-mono\">\r\n                        GEO-FAL S.A.S ÔÇó Seguridad Interna\r\n                    </p>\r\n                </div>\r\n            </div>\r\n        )\r\n    }\r\n\r\n    // 3. Main Dashboard View\r\n    return (\r\n        <div className=\"flex flex-col h-screen bg-white\">\r\n            {/* Header / Actions */}\r\n            <div className=\"h-14 border-b border-zinc-200 flex items-center justify-between px-4 bg-white shrink-0 shadow-sm z-10\">\r\n                <div className=\"flex items-center gap-4\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <div className=\"bg-blue-600 text-white p-1.5 rounded-md shadow-sm\">\r\n                            <RefreshCw className=\"w-4 h-4\" />\r\n                        </div>\r\n                        <h1 className=\"font-semibold text-lg tracking-tight text-zinc-800\">\r\n                            Programaci├│n\r\n                        </h1>\r\n                        <span className=\"text-xs text-zinc-500 bg-zinc-100 px-2 py-0.5 rounded-full border border-zinc-200 font-mono\">\r\n                            {data.length}\r\n                        </span>\r\n                    </div>\r\n\r\n                    {/* VIEW TOGGLE TABS */}\r\n                    <div className=\"flex bg-zinc-100 p-1 rounded-lg border border-zinc-200\">\r\n                        {getCanView(\"LAB\") && (\r\n                            <button\r\n                                onClick={() => setViewMode(\"LAB\")}\r\n                                className={`px-4 py-1 text-xs font-semibold rounded-md transition-all ${viewMode === \"LAB\" ? \"bg-white text-blue-600 shadow-sm\" : \"text-zinc-500 hover:text-zinc-700\"}`}\r\n                            >\r\n                                Laboratorio\r\n                            </button>\r\n                        )}\r\n                        {getCanView(\"COM\") && (\r\n                            <button\r\n                                onClick={() => setViewMode(\"COM\")}\r\n                                className={`px-4 py-1 text-xs font-semibold rounded-md transition-all ${viewMode === \"COM\" ? \"bg-white text-blue-600 shadow-sm\" : \"text-zinc-500 hover:text-zinc-700\"}`}\r\n                            >\r\n                                Comercial\r\n                            </button>\r\n                        )}\r\n                        {getCanView(\"ADMIN\") && (\r\n                            <button\r\n                                onClick={() => setViewMode(\"ADMIN\")}\r\n                                className={`px-4 py-1 text-xs font-semibold rounded-md transition-all ${viewMode === \"ADMIN\" ? \"bg-white text-blue-600 shadow-sm\" : \"text-zinc-500 hover:text-zinc-700\"}`}\r\n                            >\r\n                                Administraci├│n\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n\r\n                    {!canWrite && (\r\n                        <span className=\"px-2.5 py-1 text-[10px] uppercase font-bold text-amber-600 bg-amber-50 border border-amber-200 rounded-md flex items-center gap-1.5 cursor-default\" title=\"Solo lectura para esta vista\">\r\n                            <Info className=\"w-3 h-3\" />\r\n                            Vista Solo Lectura\r\n                        </span>\r\n                    )}\r\n                </div>\r\n\r\n                <div className=\"flex items-center gap-3\">\r\n                    <button\r\n                        onClick={() => exportToExcel(data)}\r\n                        disabled={data.length === 0}\r\n                        className=\"flex items-center gap-1.5 px-3 py-1.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-md text-xs font-medium transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed\"\r\n                    >\r\n                        <FileDown className=\"w-3.5 h-3.5\" />\r\n                        <span>Exportar Excel</span>\r\n                    </button>\r\n\r\n                    <div className=\"flex items-center gap-3\">\r\n                        <div className=\"flex items-center gap-1.5 px-2 py-1 rounded-md bg-zinc-50 border border-zinc-200 shadow-inner\" title={`Estado Realtime: ${realtimeStatus}`}>\r\n                            {realtimeStatus === \"SUBSCRIBED\" ? (\r\n                                <Wifi className=\"w-3.5 h-3.5 text-emerald-500\" />\r\n                            ) : (\r\n                                <WifiOff className=\"w-3.5 h-3.5 text-red-500 animate-pulse\" />\r\n                            )}\r\n                            <span className=\"text-[10px] uppercase font-bold text-zinc-500 hidden sm:inline\">\r\n                                {realtimeStatus === \"SUBSCRIBED\" ? \"En L├¡nea\" : \"Sin Conexi├│n\"}\r\n                            </span>\r\n                        </div>\r\n                        {isLoading && <span className=\"text-xs text-blue-500 animate-pulse font-medium\">Sincronizando...</span>}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Main Content Area */}\r\n            <div className=\"flex-1 overflow-hidden bg-zinc-50 p-1\">\r\n                <DataTable\r\n                    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n                    columns={currentColumns as any}\r\n                    data={data}\r\n                    loading={isLoading}\r\n                    onUpdate={updateField}\r\n                    onInsert={canWrite ? insertRow : undefined}\r\n                    userRole={role || ''}\r\n                    canWrite={canWrite}\r\n                    permissions={permissions}\r\n                    viewMode={viewMode}\r\n                    key={viewMode} // Force remount on view change to reset table state\r\n                />\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\components\\datagrid\\authorization-select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\components\\datagrid\\columns-admin.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'OTCell' is defined but never used.","line":13,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":11,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"OTCell"},"fix":{"range":[328,341],"text":""},"desc":"Remove unused variable \"OTCell\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SmartDateCell' is defined but never used.","line":14,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":18,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"SmartDateCell"},"fix":{"range":[341,361],"text":""},"desc":"Remove unused variable \"SmartDateCell\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":34,"column":56,"nodeType":"Identifier","messageId":"unusedVar","endLine":34,"endColumn":61}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":34,"column":100,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":103,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1419,1422],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1419,1422],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1773,1776],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1773,1776],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":111,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5298,5301],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5298,5301],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":142,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":142,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6747,6750],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6747,6750],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\n\"use client\"\r\n\r\nimport { Column, ColumnDef } from \"@tanstack/react-table\"\r\nimport { ProgramacionServicio } from \"@/types/programacion\"\r\nimport React from \"react\"\r\nimport { ArrowUpDown } from \"lucide-react\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\n// Import shared smart cells from the main columns file\r\nimport {\r\n    EditableCell,\r\n    OTCell,\r\n    SmartDateCell,\r\n    CotizacionCell,\r\n    AutorizacionCell,\r\n    PaymentStatusCell\r\n} from \"./columns\"\r\n\r\nconst SortableHeader = ({ column, title, className }: { column: Column<ProgramacionServicio, unknown>, title: string, className?: string }) => {\r\n    return (\r\n        <div\r\n            className={cn(\"flex items-center space-x-2 cursor-pointer select-none group hover:bg-slate-100/50 p-1 rounded\", className)}\r\n            onClick={() => column.toggleSorting(column.getIsSorted() === \"asc\")}\r\n        >\r\n            <span className={cn(\"font-semibold whitespace-pre-line text-center leading-tight\", className ? \"text-current\" : \"text-zinc-700\")}>{title}</span>\r\n            <ArrowUpDown className={cn(\"ml-2 h-3.5 w-3.5 shrink-0\", className ? \"text-indigo-300 group-hover:text-indigo-600\" : \"text-zinc-400 group-hover:text-zinc-700\")} />\r\n        </div>\r\n    )\r\n}\r\n\r\n// Admin Specific: Facturacion Cell\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nconst FacturacionCell = React.memo(({ getValue, row: { index, original }, column: { id }, table }: any) => {\r\n    const value = getValue() as string\r\n    const [isEditing, setIsEditing] = React.useState(false)\r\n    const [inputValue, setInputValue] = React.useState(value || \"\")\r\n\r\n    // Permission: depends on permissions.administracion.write\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const meta = table.options.meta as any\r\n    const canWrite = meta?.canWrite || meta?.permissions?.administracion?.write || false\r\n\r\n    const onBlur = () => {\r\n        setIsEditing(false)\r\n        if (!canWrite) return\r\n        let finalValue = inputValue.trim()\r\n        if (finalValue) {\r\n            if (/^\\d+$/.test(finalValue)) {\r\n                const paddedNum = finalValue.length < 4 ? finalValue.padStart(4, '0') : finalValue\r\n                finalValue = `F001-${paddedNum}`\r\n            } else if (/^(\\d+)-(\\d+)$/.test(finalValue)) {\r\n                const match = finalValue.match(/^(\\d+)-(\\d+)$/)\r\n                if (match) {\r\n                    finalValue = `F${match[1].padStart(3, '0')}-${match[2].padStart(4, '0')}`\r\n                }\r\n            } else if (/^[fF]\\d+$/.test(finalValue)) {\r\n                const nums = finalValue.slice(1)\r\n                const paddedNum = nums.length < 4 ? nums.padStart(4, '0') : nums\r\n                finalValue = `F001-${paddedNum}`\r\n            }\r\n        }\r\n        if (finalValue !== value) {\r\n            table.options.meta?.updateData(original.id, id, finalValue)\r\n        }\r\n    }\r\n\r\n    if (isEditing && canWrite) {\r\n        return <input autoFocus value={inputValue} onChange={e => setInputValue(e.target.value)} onBlur={onBlur} className=\"w-full h-full bg-white border border-blue-300 rounded text-sm p-1 text-zinc-900 font-medium\" placeholder=\"Ej: 1234 o 002-5678\" />\r\n    }\r\n\r\n    return (\r\n        <div\r\n            onClick={() => { if (canWrite) { setInputValue(value || \"\"); setIsEditing(true); } }}\r\n            className={cn(\"w-full h-full flex items-center px-1 text-sm truncate text-zinc-900 font-medium\", canWrite ? \"cursor-pointer hover:bg-slate-50\" : \"cursor-not-allowed opacity-70\")}\r\n        >\r\n            {value || <span className=\"text-zinc-300 italic\">...</span>}\r\n        </div>\r\n    )\r\n})\r\nFacturacionCell.displayName = \"FacturacionCell\"\r\n\r\nexport const columnsAdmin: ColumnDef<ProgramacionServicio>[] = [\r\n    {\r\n        accessorKey: \"item_numero\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"ITEM\" />,\r\n        size: 69, minSize: 69, maxSize: 69, enablePinning: true, enableResizing: false,\r\n        cell: info => <div className=\"text-zinc-400 font-mono text-sm text-center bg-white h-full flex items-center justify-center\">{info.getValue() as string}</div>\r\n    },\r\n    {\r\n        accessorKey: \"recep_numero\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"RECEP\" />,\r\n        size: 100, minSize: 100, maxSize: 100, enablePinning: true, enableResizing: false,\r\n        cell: ({ getValue }) => <div className=\"text-zinc-900 font-medium px-2\">{getValue() as string}</div>,\r\n    },\r\n    {\r\n        accessorKey: \"cliente_nombre\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"CLIENTE\" />,\r\n        size: 200, minSize: 150, maxSize: 400, enableResizing: true,\r\n        cell: ({ getValue, row, column, table }) => (\r\n            <div className=\"line-clamp-2 whitespace-normal leading-tight text-[12.5px]\" title={getValue() as string}>\r\n                <EditableCell getValue={getValue} row={row} column={column} table={table} className=\"text-[12.5px] leading-3\" />\r\n            </div>\r\n        )\r\n    },\r\n    {\r\n        accessorKey: \"proyecto\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"PROYECTO\" />,\r\n        size: 150, minSize: 100, maxSize: 400, enableResizing: true,\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        cell: (props: any) => <EditableCell {...props} className=\"text-zinc-900\" />,\r\n    },\r\n    {\r\n        accessorKey: \"cotizacion_lab\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"COTIZACION\" />,\r\n        size: 160, minSize: 120, maxSize: 300, enableResizing: true,\r\n        cell: CotizacionCell,\r\n    },\r\n    {\r\n        accessorKey: \"numero_factura\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"FACTURACION\" className=\"text-blue-700\" />,\r\n        size: 160, minSize: 120, maxSize: 250, enableResizing: true,\r\n        cell: FacturacionCell,\r\n    },\r\n    {\r\n        accessorKey: \"estado_pago\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"ESTADO PAGO\" className=\"text-emerald-700\" />,\r\n        size: 130, minSize: 100, maxSize: 200, enableResizing: true,\r\n        cell: PaymentStatusCell,\r\n    },\r\n    {\r\n        accessorKey: \"autorizacion_lab\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"AUTORIZADO\" className=\"bg-indigo-50/50 text-indigo-900\" />,\r\n        size: 180, minSize: 120, maxSize: 300, enableResizing: true,\r\n        cell: AutorizacionCell,\r\n    },\r\n    {\r\n        accessorKey: \"nota_admin\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"NOTA ADMIN\" />,\r\n        size: 250, minSize: 150, maxSize: 600, enableResizing: true,\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        cell: (props: any) => <EditableCell {...props} />,\r\n    }\r\n]\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\components\\datagrid\\columns-comercial.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'OTCell' is defined but never used.","line":13,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":11,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"OTCell"},"fix":{"range":[328,341],"text":""},"desc":"Remove unused variable \"OTCell\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AutorizacionCell' is defined but never used.","line":16,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":16,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"AutorizacionCell"},"fix":{"range":[382,405],"text":""},"desc":"Remove unused variable \"AutorizacionCell\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'PaymentStatusCell' is defined but never used.","line":17,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":17,"endColumn":22,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"PaymentStatusCell"},"fix":{"range":[405,429],"text":""},"desc":"Remove unused variable \"PaymentStatusCell\"."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":94,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":94,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4464,4467],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4464,4467],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":127,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":127,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5972,5975],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5972,5975],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\n\"use client\"\r\n\r\nimport { Column, ColumnDef } from \"@tanstack/react-table\"\r\nimport { ProgramacionServicio } from \"@/types/programacion\"\r\nimport React from \"react\"\r\nimport { ArrowUpDown } from \"lucide-react\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\n// Import shared smart cells from the main columns file\r\nimport {\r\n    EditableCell,\r\n    OTCell,\r\n    SmartDateCell,\r\n    CotizacionCell,\r\n    AutorizacionCell,\r\n    PaymentStatusCell\r\n} from \"./columns\"\r\n\r\nconst SortableHeader = ({ column, title, className }: { column: Column<ProgramacionServicio, unknown>, title: string, className?: string }) => {\r\n    return (\r\n        <div\r\n            className={cn(\"flex items-center justify-center space-x-1 cursor-pointer select-none group hover:bg-slate-100/50 p-1.5 rounded w-full h-full min-h-[40px]\", className)}\r\n            onClick={() => column.toggleSorting(column.getIsSorted() === \"asc\")}\r\n        >\r\n            <span className={cn(\"font-bold whitespace-pre-line text-center leading-tight text-[11px] uppercase tracking-tight\", className ? \"text-current\" : \"text-zinc-700\")}>{title}</span>\r\n            <ArrowUpDown className={cn(\"ml-1 h-3 w-3 shrink-0 opacity-0 group-hover:opacity-100 transition-opacity\", className ? \"text-indigo-400\" : \"text-zinc-400\")} />\r\n        </div>\r\n    )\r\n}\r\n\r\nexport const columnsComercial: ColumnDef<ProgramacionServicio>[] = [\r\n    {\r\n        accessorKey: \"item_numero\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"ITEM\" />,\r\n        size: 70, minSize: 70, maxSize: 70, enablePinning: true, enableResizing: false,\r\n        cell: info => <div className=\"text-zinc-400 font-mono text-sm text-center bg-white h-full flex items-center justify-center border-r border-zinc-100\">{info.getValue() as string}</div>\r\n    },\r\n    {\r\n        accessorKey: \"recep_numero\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"RECEP. N\" />,\r\n        size: 85, minSize: 85, maxSize: 85, enablePinning: true, enableResizing: false,\r\n        cell: ({ getValue }) => <div className=\"text-zinc-900 font-bold px-2 text-center\">{getValue() as string}</div>,\r\n    },\r\n    {\r\n        accessorKey: \"fecha_recepcion\",\r\n        header: ({ column }) => <SortableHeader column={column} title={`FECHA\\nRECEPCI├ôN`} />,\r\n        size: 110, minSize: 110, maxSize: 110,\r\n        cell: ({ getValue }) => {\r\n            const dateStr = getValue() as string\r\n            if (!dateStr) return <div className=\"text-zinc-300 text-center\">-</div>\r\n            return <div className=\"text-zinc-900 text-center text-sm font-medium\">{dateStr.split('-').reverse().join('/')}</div>\r\n        }\r\n    },\r\n    {\r\n        accessorKey: \"cliente_nombre\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"CLIENTE\" />,\r\n        size: 200, minSize: 150, maxSize: 400, enableResizing: true,\r\n        cell: ({ getValue }) => (\r\n            <div className=\"line-clamp-2 whitespace-normal leading-tight text-[12px] font-bold text-zinc-900 uppercase\" title={getValue() as string}>\r\n                {getValue() as string}\r\n            </div>\r\n        )\r\n    },\r\n    {\r\n        accessorKey: \"proyecto\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"PROYECTO\" />,\r\n        size: 200, minSize: 150, maxSize: 500, enableResizing: true,\r\n        cell: ({ getValue }) => <div className=\"text-zinc-900 font-medium whitespace-normal leading-tight\">{getValue() as string}</div>,\r\n    },\r\n    {\r\n        accessorKey: \"cotizacion_lab\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"COTIZACION\" />,\r\n        size: 160, minSize: 140, maxSize: 300, enableResizing: true,\r\n        cell: CotizacionCell,\r\n    },\r\n    {\r\n        accessorKey: \"fecha_solicitud_com\",\r\n        header: ({ column }) => <SortableHeader column={column} title={`FECHA\\nSOLICITUD`} />,\r\n        size: 110, minSize: 110, maxSize: 110,\r\n        cell: SmartDateCell,\r\n    },\r\n    {\r\n        accessorKey: \"fecha_entrega_com\",\r\n        header: ({ column }) => <SortableHeader column={column} title={`FECHA\\nENTREGA`} />,\r\n        size: 110, minSize: 110, maxSize: 110,\r\n        cell: SmartDateCell,\r\n    },\r\n    {\r\n        accessorKey: \"evidencia_solicitud_envio\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"EVIDENCIAS\" />,\r\n        size: 110, minSize: 110, maxSize: 150, enableResizing: true,\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        cell: (props: any) => <EditableCell {...props} className=\"text-zinc-800 text-[12px] text-center\" />,\r\n    },\r\n    {\r\n        accessorKey: \"dias_atraso_envio_coti\",\r\n        header: ({ column }) => <SortableHeader column={column} title={`DIAS ATRASO\\nENVIO COTIZ.`} />,\r\n        size: 110, minSize: 100, maxSize: 150, enableResizing: true,\r\n        cell: ({ row }) => {\r\n            const solicitudDateStr = row.original.fecha_solicitud_com\r\n            const entregaDateStr = row.original.fecha_entrega_com\r\n\r\n            if (!solicitudDateStr || !entregaDateStr) return <div className=\"text-zinc-300 text-center\">-</div>\r\n\r\n            const solicitud = new Date(solicitudDateStr)\r\n            const entrega = new Date(entregaDateStr)\r\n\r\n            solicitud.setHours(0, 0, 0, 0)\r\n            entrega.setHours(0, 0, 0, 0)\r\n\r\n            const diffTime = entrega.getTime() - solicitud.getTime()\r\n            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24))\r\n\r\n            return (\r\n                <div className={`text-center font-mono text-sm ${diffDays > 0 ? \"text-zinc-900\" : \"text-zinc-900\"}`}>\r\n                    {diffDays}\r\n                </div>\r\n            )\r\n        }\r\n    },\r\n    {\r\n        accessorKey: \"motivo_dias_atraso_com\",\r\n        header: ({ column }) => <SortableHeader column={column} title={`MOTIVO\\nDIAS ATRASO`} />,\r\n        size: 400, minSize: 200, maxSize: 800, enableResizing: true,\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        cell: (props: any) => <EditableCell {...props} className=\"text-zinc-800 text-[12px]\" />,\r\n    },\r\n]\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\components\\datagrid\\columns.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TData' is defined but never used.","line":14,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":14,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":46,"column":53,"nodeType":"Identifier","messageId":"unusedVar","endLine":46,"endColumn":58},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isFocused' is assigned a value but never used.","line":49,"column":12,"nodeType":"Identifier","messageId":"unusedVar","endLine":49,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":209,"column":47,"nodeType":"Identifier","messageId":"unusedVar","endLine":209,"endColumn":52},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":284,"column":54,"nodeType":"Identifier","messageId":"unusedVar","endLine":284,"endColumn":59},{"ruleId":"prefer-const","severity":2,"message":"'finalVal' is never reassigned. Use 'const' instead.","line":326,"column":13,"nodeType":"Identifier","messageId":"useConst","endLine":326,"endColumn":21,"fix":{"range":[13493,13525],"text":"const finalVal = inputValue.trim()"}},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":429,"column":58,"nodeType":"Identifier","messageId":"unusedVar","endLine":429,"endColumn":63},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":500,"column":55,"nodeType":"Identifier","messageId":"unusedVar","endLine":500,"endColumn":60},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'index' is defined but never used.","line":630,"column":57,"nodeType":"Identifier","messageId":"unusedVar","endLine":630,"endColumn":62}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":53,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2028,2031],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2028,2031],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":220,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":220,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8813,8816],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8813,8816],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":303,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":303,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12505,12508],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12505,12508],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":436,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":436,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18404,18407],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18404,18407],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":507,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":507,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22282,22285],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22282,22285],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":598,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":598,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26283,26286],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26283,26286],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":635,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":635,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28094,28097],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28094,28097],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":678,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":678,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30052,30055],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30052,30055],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":1,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":1,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Column, ColumnDef, RowData, Table } from \"@tanstack/react-table\"\r\nimport { ProgramacionServicio } from \"@/types/programacion\"\r\nimport React from \"react\"\r\nimport { ArrowUpDown } from \"lucide-react\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { StatusSelect } from \"./status-select\"\r\nimport { AuthorizationSelect } from \"./authorization-select\"\r\nimport { PaymentSelect } from \"./payment-select\"\r\n\r\n// Extend meta to support custom cell editing\r\ndeclare module \"@tanstack/react-table\" {\r\n    interface TableMeta<TData extends RowData> {\r\n        updateData: (rowId: string, columnId: string, value: unknown) => void\r\n    }\r\n}\r\n\r\n// Utility to format date as DD/MM/YY\r\nconst formatDateToShort = (dateStr: string | null) => {\r\n    if (!dateStr) return null\r\n    try {\r\n        const date = new Date(dateStr)\r\n        if (isNaN(date.getTime())) return dateStr\r\n        const day = String(date.getDate()).padStart(2, '0')\r\n        const month = String(date.getMonth() + 1).padStart(2, '0')\r\n        const year = String(date.getFullYear()).slice(-2)\r\n        return `${day}/${month}/${year}`\r\n    } catch {\r\n        return dateStr\r\n    }\r\n}\r\n\r\n// Export components for use in other column definitions\r\nexport { EditableCell, OTCell, SmartDateCell, CotizacionCell, AutorizacionCell, PaymentStatusCell, StatusCell }\r\n\r\nexport type EditableCellProps<TData> = {\r\n    getValue: () => unknown\r\n    row: { index: number, original: TData }\r\n    column: { id: string }\r\n    table: Table<TData>\r\n    className?: string\r\n}\r\n\r\n// Editable Cell Component\r\nconst EditableCell = React.memo(({ getValue, row: { index, original }, column: { id }, table, className }: EditableCellProps<ProgramacionServicio>) => {\r\n    const initialValue = getValue()\r\n    const [value, setValue] = React.useState(initialValue)\r\n    const [isFocused, setIsFocused] = React.useState(false)\r\n\r\n    // --- Column-Based Permissions by Role ---\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const meta = table.options.meta as any\r\n    const userRole = (meta?.userRole || \"\").toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n\r\n    // Role-based column restrictions\r\n    // lector = NO puede editar NADA\r\n    // tipificador = Puede editar TODO excepto cotizacion_lab, autorizacion_lab\r\n    // vendor = Puede editar TODO excepto estado_pago\r\n    // administrativo = Puede editar TODO excepto cotizacion_lab\r\n    // admin = Puede editar TODO\r\n\r\n    const getCanWriteColumn = (): boolean => {\r\n        // If global canWrite is explicitly false, block everything\r\n        const globalCanWrite = meta?.canWrite\r\n        const viewMode = meta?.viewMode || \"\"\r\n\r\n        // Role restrictions for ADMIN: should follow the view's specific logic\r\n        if (userRole === 'admin') {\r\n            if (viewMode === 'LAB') {\r\n                const blockedColumns = ['cotizacion_lab', 'autorizacion_lab']\r\n                if (blockedColumns.includes(id)) return false\r\n            }\r\n            if (viewMode === 'COM') {\r\n                const blockedColumns = ['estado_pago']\r\n                if (blockedColumns.includes(id)) return false\r\n            }\r\n            if (viewMode === 'ADMIN') {\r\n                const blockedColumns = ['cotizacion_lab', 'cliente_nombre', 'proyecto']\r\n                if (blockedColumns.includes(id)) return false\r\n            }\r\n            return true\r\n        }\r\n\r\n        // Role: laboratorio_lector - Cannot edit anything\r\n        if (userRole === 'laboratorio_lector' || userRole.includes('lector')) {\r\n            return false\r\n        }\r\n\r\n        // Role: laboratorio_tipificador - Can edit everything EXCEPT cotizacion_lab, autorizacion_lab\r\n        if (userRole === 'laboratorio_tipificador' || (userRole.includes('laboratorio') && userRole.includes('tipificador'))) {\r\n            const blockedColumns = ['cotizacion_lab', 'autorizacion_lab']\r\n            if (blockedColumns.includes(id)) return false\r\n            return true\r\n        }\r\n\r\n        // Role: vendor (vendedor) - Can edit everything EXCEPT estado_pago\r\n        if (userRole === 'vendor' || userRole.includes('vendedor') || userRole.includes('asesor') || userRole.includes('comercial')) {\r\n            const blockedColumns = ['estado_pago']\r\n            if (blockedColumns.includes(id)) return false\r\n            return true\r\n        }\r\n\r\n        // Role: administrativo - Can edit everything EXCEPT cotizacion_lab\r\n        if (userRole === 'administrativo') {\r\n            const blockedColumns = ['cotizacion_lab', 'cliente_nombre', 'proyecto']\r\n            if (blockedColumns.includes(id)) return false\r\n            return true\r\n        }\r\n\r\n        // Default: use global canWrite from permissions\r\n        return globalCanWrite ?? false\r\n    }\r\n\r\n    const canWrite = getCanWriteColumn()\r\n\r\n\r\n\r\n    // Sync external changes\r\n    React.useEffect(() => {\r\n        setValue(initialValue)\r\n    }, [initialValue])\r\n\r\n    const onBlur = () => {\r\n        setIsFocused(false)\r\n        if (value !== initialValue) {\r\n            table.options.meta?.updateData(original.id, id, value)\r\n        }\r\n    }\r\n\r\n    // Navigation Logic\r\n    const onKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement | HTMLInputElement>) => {\r\n        if (e.key === 'Enter') {\r\n            e.preventDefault()\r\n            e.currentTarget.blur()\r\n\r\n            // Wait for blur to process, then move focus\r\n            setTimeout(() => {\r\n                const allInputs = Array.from(document.querySelectorAll('input:not([type=\"hidden\"]), textarea, select')) as HTMLElement[];\r\n                const currentElement = e.target as HTMLElement;\r\n                const currentIndex = allInputs.indexOf(currentElement);\r\n\r\n                if (currentIndex !== -1 && currentIndex < allInputs.length - 1) {\r\n                    allInputs[currentIndex + 1].focus();\r\n                    if (allInputs[currentIndex + 1] instanceof HTMLInputElement) {\r\n                        (allInputs[currentIndex + 1] as HTMLInputElement).select();\r\n                    }\r\n                }\r\n            }, 0)\r\n        }\r\n    }\r\n\r\n    const isDate = id.includes('fecha') || id === 'entrega_real'\r\n    const colorClass = canWrite ? \"text-zinc-900\" : \"text-zinc-900\"\r\n    const textSize = className?.includes('text-') ? '' : 'text-sm'\r\n\r\n    if (!canWrite) {\r\n        return (\r\n            <div className={cn(\"px-1 py-1 truncate cursor-not-allowed bg-zinc-50/30 font-medium\", colorClass, textSize, className)} title=\"Sin permiso de edici├│n\">\r\n                {isDate ? formatDateToShort(value as string) : (value as string || \"-\")}\r\n            </div>\r\n        )\r\n    }\r\n\r\n    if (isDate) {\r\n        return (\r\n            <input\r\n                type=\"date\"\r\n                value={(value as string)?.split('T')[0] ?? \"\"}\r\n                onChange={e => setValue(e.target.value)}\r\n                onBlur={onBlur}\r\n                onKeyDown={onKeyDown}\r\n                onFocus={() => setIsFocused(true)}\r\n                className={cn(\r\n                    \"w-full bg-transparent border-none focus:outline-none focus:ring-1 focus:ring-blue-500 rounded px-1 -mx-1 h-full placeholder:text-zinc-400\",\r\n                    colorClass,\r\n                    textSize,\r\n                    className\r\n                )}\r\n            />\r\n        )\r\n    }\r\n\r\n    return (\r\n        <textarea\r\n            value={(value as string) ?? \"\"}\r\n            onChange={e => setValue(e.target.value)}\r\n            onBlur={onBlur}\r\n            onKeyDown={onKeyDown}\r\n            onFocus={() => setIsFocused(true)}\r\n            rows={1}\r\n            style={{\r\n                fieldSizing: \"content\",\r\n                minHeight: \"1.5em\",\r\n                resize: \"none\"\r\n            }}\r\n            className={cn(\r\n                \"w-full bg-transparent border-none focus:outline-none focus:ring-1 focus:ring-blue-500 rounded px-1 -mx-1 resize-none overflow-hidden block leading-tight whitespace-pre-wrap py-1 placeholder:text-zinc-400\",\r\n                colorClass,\r\n                textSize,\r\n                className\r\n            )}\r\n        />\r\n    )\r\n})\r\nEditableCell.displayName = \"EditableCell\"\r\n\r\n// OT Cell (Auto-adds -26 when user enters just digits)\r\nconst OTCell = React.memo(({ getValue, row: { index, original }, column: { id }, table }: EditableCellProps<ProgramacionServicio>) => {\r\n    const rawValue = getValue() as string\r\n    const cleanValue = (val: string) => val ? val.replace(/LEM/i, '').replace(/-26$/, '').trim() : \"\"\r\n    const [value, setValue] = React.useState(cleanValue(rawValue))\r\n\r\n    React.useEffect(() => {\r\n        setValue(cleanValue(rawValue))\r\n    }, [rawValue])\r\n\r\n    // Permission check - Column-based restrictions by role\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const meta = table.options.meta as any\r\n    const userRole = (meta?.userRole || \"\").toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n\r\n    const getCanWriteColumn = (): boolean => {\r\n        if (userRole === 'admin') return true\r\n        if (userRole === 'laboratorio_lector' || userRole.includes('lector')) return false\r\n        if (userRole === 'laboratorio_tipificador' || (userRole.includes('laboratorio') && userRole.includes('tipificador'))) return true\r\n        if (userRole === 'vendor' || userRole.includes('vendedor') || userRole.includes('asesor') || userRole.includes('comercial')) return true\r\n        if (userRole === 'administrativo') return true\r\n        return meta?.canWrite ?? false\r\n    }\r\n    const canWrite = getCanWriteColumn()\r\n\r\n    const onBlur = () => {\r\n        if (!canWrite) return\r\n        let finalValue = value.trim()\r\n        if (finalValue && /^\\d+$/.test(finalValue)) {\r\n            finalValue = `${finalValue}-26`\r\n        } else if (finalValue && !finalValue.includes('-26')) {\r\n            finalValue = finalValue.replace(/-$/, '')\r\n            if (/^\\d+$/.test(finalValue)) {\r\n                finalValue = `${finalValue}-26`\r\n            }\r\n        }\r\n        if (finalValue !== rawValue) {\r\n            table.options.meta?.updateData(original.id, id, finalValue)\r\n        }\r\n    }\r\n\r\n    const onKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\r\n        if (e.key === 'Enter') {\r\n            e.preventDefault()\r\n            e.currentTarget.blur()\r\n            setTimeout(() => {\r\n                const allInputs = Array.from(document.querySelectorAll('input:not([type=\"hidden\"]), textarea, select')) as HTMLElement[];\r\n                const currentIndex = allInputs.indexOf(e.target as HTMLElement);\r\n                if (currentIndex !== -1 && currentIndex < allInputs.length - 1) {\r\n                    allInputs[currentIndex + 1].focus();\r\n                    if (allInputs[currentIndex + 1] instanceof HTMLInputElement) {\r\n                        (allInputs[currentIndex + 1] as HTMLInputElement).select();\r\n                    }\r\n                }\r\n            }, 0)\r\n        }\r\n    }\r\n\r\n    return (\r\n        <input\r\n            value={value}\r\n            onChange={e => setValue(e.target.value)}\r\n            onBlur={onBlur}\r\n            onKeyDown={onKeyDown}\r\n            disabled={!canWrite}\r\n            className={cn(\r\n                \"w-full bg-transparent border-none focus:outline-none focus:ring-1 focus:ring-blue-500 rounded px-2 -mx-1 h-full text-zinc-900 font-medium disabled:opacity-70\",\r\n                !canWrite && \"cursor-not-allowed\"\r\n            )}\r\n            placeholder=\"OT #\"\r\n        />\r\n    )\r\n})\r\nOTCell.displayName = \"OTCell\"\r\n\r\n// Smart Date Cell (DD/MM -> YYYY-MM-DD)\r\nconst SmartDateCell = React.memo(({ getValue, row: { index, original }, column: { id }, table }: EditableCellProps<ProgramacionServicio>) => {\r\n    const rawValue = getValue() as string\r\n    const formatDisplay = (val: string) => {\r\n        if (!val) return \"\"\r\n        try {\r\n            const date = new Date(val)\r\n            if (isNaN(date.getTime())) return val\r\n            const d = String(date.getUTCDate()).padStart(2, '0')\r\n            const m = String(date.getUTCMonth() + 1).padStart(2, '0')\r\n            const y = String(date.getUTCFullYear()).slice(-2)\r\n            return `${d}/${m}/${y}`\r\n        } catch { return val }\r\n    }\r\n\r\n    const [inputValue, setInputValue] = React.useState(formatDisplay(rawValue))\r\n    const [isEditing, setIsEditing] = React.useState(false)\r\n\r\n    // Permission check - Column-based restrictions by role\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const meta = table.options.meta as any\r\n    const userRole = (meta?.userRole || \"\").toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n\r\n    const getCanWriteColumn = (): boolean => {\r\n        if (userRole === 'admin') return true\r\n        if (userRole === 'laboratorio_lector' || userRole.includes('lector')) return false\r\n        if (userRole === 'laboratorio_tipificador' || (userRole.includes('laboratorio') && userRole.includes('tipificador'))) return true\r\n        if (userRole === 'vendor' || userRole.includes('vendedor') || userRole.includes('asesor') || userRole.includes('comercial')) return true\r\n        if (userRole === 'administrativo') return true\r\n        return meta?.canWrite ?? false\r\n    }\r\n    const canWrite = getCanWriteColumn()\r\n\r\n    React.useEffect(() => {\r\n        setInputValue(formatDisplay(rawValue))\r\n    }, [rawValue])\r\n\r\n    const onBlur = () => {\r\n        if (!canWrite) {\r\n            setIsEditing(false)\r\n            return\r\n        }\r\n        setIsEditing(false)\r\n        let finalVal = inputValue.trim()\r\n        let valToParse = finalVal\r\n        if (/^\\d{3}$/.test(valToParse)) valToParse = \"0\" + valToParse\r\n        const shortDateRegex = /^(\\d{1,2})[./µÄó](\\d{1,2})$/\r\n        const numericMatch = valToParse.match(/^(\\d{2})(\\d{2})(\\d{2}|\\d{4})?$/)\r\n        const match = valToParse.match(shortDateRegex)\r\n        let isoDate = null\r\n        if (numericMatch) {\r\n            const day = numericMatch[1]; const month = numericMatch[2]\r\n            let year = numericMatch[3] || \"2026\"\r\n            if (year.length === 2) year = \"20\" + year\r\n            isoDate = `${year}-${month}-${day}`\r\n        } else if (match) {\r\n            const day = match[1].padStart(2, '0'); const month = match[2].padStart(2, '0')\r\n            isoDate = `2026-${month}-${day}`\r\n        } else {\r\n            const fullDateRegex = /^(\\d{1,2})[./µÄó](\\d{1,2})[./µÄó](\\d{4}|\\d{2})$/\r\n            const fullMatch = finalVal.match(fullDateRegex)\r\n            if (fullMatch) {\r\n                const d = fullMatch[1].padStart(2, '0'); const m = fullMatch[2].padStart(2, '0')\r\n                let y = fullMatch[3]; if (y.length === 2) y = \"20\" + y\r\n                isoDate = `${y}-${m}-${d}`\r\n            }\r\n        }\r\n        if (isoDate && !isNaN(new Date(isoDate).getTime())) {\r\n            table.options.meta?.updateData(original.id, id, isoDate)\r\n            setInputValue(formatDisplay(isoDate))\r\n        } else {\r\n            if (inputValue === \"\") table.options.meta?.updateData(original.id, id, null)\r\n            else setInputValue(formatDisplay(rawValue))\r\n        }\r\n    }\r\n\r\n    const onKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\r\n        if (e.key === 'Enter') {\r\n            e.preventDefault(); e.currentTarget.blur()\r\n            setTimeout(() => {\r\n                const allInputs = Array.from(document.querySelectorAll('input:not([type=\"hidden\"]), textarea, select')) as HTMLElement[];\r\n                const currentIndex = allInputs.indexOf(e.target as HTMLElement);\r\n                if (currentIndex !== -1 && currentIndex < allInputs.length - 1) {\r\n                    allInputs[currentIndex + 1].focus();\r\n                    if (allInputs[currentIndex + 1] instanceof HTMLInputElement) (allInputs[currentIndex + 1] as HTMLInputElement).select();\r\n                }\r\n            }, 0)\r\n        }\r\n    }\r\n\r\n    if (isEditing) {\r\n        return (\r\n            <input\r\n                autoFocus\r\n                type=\"text\"\r\n                value={inputValue}\r\n                onChange={e => setInputValue(e.target.value)}\r\n                onBlur={onBlur}\r\n                onKeyDown={onKeyDown}\r\n                placeholder=\"dd/mm\"\r\n                className=\"w-full bg-white border border-blue-400 rounded px-1 -mx-1 h-full text-zinc-900 font-medium\"\r\n            />\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div\r\n            onClick={() => { if (canWrite) setIsEditing(true); }}\r\n            className={cn(\r\n                \"w-full h-full flex items-center px-1 text-zinc-900 font-medium leading-tight\",\r\n                canWrite ? \"cursor-pointer hover:bg-zinc-100/50\" : \"cursor-not-allowed bg-zinc-50/30\"\r\n            )}\r\n            title={canWrite ? \"Click para editar\" : \"Sin permiso de edici├│n\"}\r\n        >\r\n            {inputValue || <span className=\"text-zinc-300\">--/--</span>}\r\n        </div>\r\n    )\r\n})\r\nSmartDateCell.displayName = \"SmartDateCell\"\r\n\r\n// Date Display Component (Shows DD/MM/YY, becomes picker on click)\r\nconst DateDisplayCell = React.memo(({ getValue, row, column, table, className }: EditableCellProps<ProgramacionServicio>) => {\r\n    const [isEditing, setIsEditing] = React.useState(false)\r\n    const value = getValue() as string\r\n    const formatted = formatDateToShort(value)\r\n\r\n    if (isEditing) {\r\n        return (\r\n            <div onBlur={() => setIsEditing(false)}>\r\n                <EditableCell getValue={getValue} row={row} column={column} table={table} className={className} />\r\n            </div>\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div\r\n            onClick={() => setIsEditing(true)}\r\n            className={cn(\"w-full h-full cursor-pointer hover:bg-zinc-100/50 flex items-center px-1 text-zinc-900\", className)}\r\n        >\r\n            {formatted || <span className=\"text-zinc-300\">--/--/--</span>}\r\n        </div>\r\n    )\r\n})\r\nDateDisplayCell.displayName = \"DateDisplayCell\"\r\n\r\n// Codigo Muestra Cell (Wraps text, multi-line display)\r\nconst CodigoMuestraCell = React.memo(({ getValue, row: { index, original }, column: { id }, table }: EditableCellProps<ProgramacionServicio>) => {\r\n    const value = getValue() as string\r\n    const [isEditing, setIsEditing] = React.useState(false)\r\n    const [inputValue, setInputValue] = React.useState(value || \"\")\r\n\r\n    // Permission check - Column-based restrictions by role\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const meta = table.options.meta as any\r\n    const userRole = (meta?.userRole || \"\").toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n\r\n    const getCanWriteColumn = (): boolean => {\r\n        if (userRole === 'admin') return true\r\n        if (userRole === 'laboratorio_lector' || userRole.includes('lector')) return false\r\n        if (userRole === 'laboratorio_tipificador' || (userRole.includes('laboratorio') && userRole.includes('tipificador'))) return true\r\n        if (userRole === 'vendor' || userRole.includes('vendedor') || userRole.includes('asesor') || userRole.includes('comercial')) return true\r\n        if (userRole === 'administrativo') return true\r\n        return meta?.canWrite ?? false\r\n    }\r\n    const canWrite = getCanWriteColumn()\r\n\r\n    const onBlur = () => {\r\n        setIsEditing(false)\r\n        if (inputValue !== value) {\r\n            table.options.meta?.updateData(original.id, id, inputValue)\r\n        }\r\n    }\r\n\r\n    const onKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\r\n        if (e.key === 'Enter') {\r\n            e.preventDefault(); e.currentTarget.blur()\r\n            setTimeout(() => {\r\n                const allInputs = Array.from(document.querySelectorAll('input:not([type=\"hidden\"]), textarea, select')) as HTMLElement[];\r\n                const currentIndex = allInputs.indexOf(e.target as HTMLElement);\r\n                if (currentIndex !== -1 && currentIndex < allInputs.length - 1) {\r\n                    allInputs[currentIndex + 1].focus();\r\n                    if (allInputs[currentIndex + 1] instanceof HTMLInputElement) (allInputs[currentIndex + 1] as HTMLInputElement).select();\r\n                }\r\n            }, 0)\r\n        }\r\n    }\r\n\r\n    if (isEditing) {\r\n        return <input autoFocus value={inputValue} onChange={e => setInputValue(e.target.value)} onBlur={onBlur} onKeyDown={onKeyDown} className=\"w-full h-full bg-white border border-blue-300 rounded text-sm px-1 font-medium text-zinc-900\" />\r\n    }\r\n\r\n    return (\r\n        <div\r\n            onClick={() => { if (canWrite) { setInputValue(value || \"\"); setIsEditing(true); } }}\r\n            className={cn(\"w-full h-full flex items-center px-1 text-sm text-zinc-900 font-medium leading-tight break-words\", canWrite ? \"cursor-pointer hover:bg-slate-50\" : \"cursor-not-allowed bg-zinc-50/30\")}\r\n            title={value || \"Click para editar\"}\r\n        >\r\n            <span className=\"line-clamp-3\">{value || <span className=\"text-zinc-300 italic\">...</span>}</span>\r\n        </div>\r\n    )\r\n})\r\nCodigoMuestraCell.displayName = \"CodigoMuestraCell\"\r\n\r\nconst SortableHeader = ({ column, title, className }: { column: Column<ProgramacionServicio, unknown>, title: string, className?: string }) => {\r\n    return (\r\n        <div\r\n            className={cn(\"flex items-center justify-center space-x-1 cursor-pointer select-none group hover:bg-slate-100/50 px-2 py-1.5 rounded\", className)}\r\n            onClick={() => column.toggleSorting(column.getIsSorted() === \"asc\")}\r\n        >\r\n            <span className={cn(\"font-semibold whitespace-pre-line text-center leading-tight text-zinc-800\", className)}>{title}</span>\r\n            <ArrowUpDown className={cn(\"h-3 w-3 shrink-0 text-zinc-400 group-hover:text-zinc-700\")} />\r\n        </div>\r\n    )\r\n}\r\n\r\n// Cotizacion Cell (Auto-formats number to COTIZ.N-XXX-26)\r\n// Granular: Depends on permissions.comercial.write\r\nconst CotizacionCell = React.memo(({ getValue, row: { index, original }, column: { id }, table }: EditableCellProps<ProgramacionServicio>) => {\r\n    const value = getValue() as string\r\n    const [isEditing, setIsEditing] = React.useState(false)\r\n    const [inputValue, setInputValue] = React.useState(value || \"\")\r\n\r\n    // --- Column-based permissions: tipificador and administrativo CANNOT edit cotizacion_lab ---\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const meta = table.options.meta as any\r\n    const userRole = (meta?.userRole || \"\").toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n\r\n    const getCanEditCotizacion = (): boolean => {\r\n        const viewMode = meta?.viewMode || \"\"\r\n        if (userRole === 'admin') {\r\n            if (viewMode === 'LAB' || viewMode === 'ADMIN') return false\r\n            return true\r\n        }\r\n        // tipificador cannot edit cotizacion\r\n        if (userRole === 'laboratorio_tipificador' || (userRole.includes('laboratorio') && userRole.includes('tipificador'))) return false\r\n        // administrativo cannot edit cotizacion\r\n        if (userRole === 'administrativo') return false\r\n        // lector cannot edit anything\r\n        if (userRole === 'laboratorio_lector' || userRole.includes('lector')) return false\r\n        // vendor CAN edit cotizacion\r\n        if (userRole === 'vendor' || userRole.includes('vendedor') || userRole.includes('asesor') || userRole.includes('comercial')) return true\r\n        return meta?.canWrite ?? false\r\n    }\r\n    const canEdit = getCanEditCotizacion()\r\n\r\n    const onBlur = () => {\r\n        setIsEditing(false)\r\n        if (!canEdit) return\r\n\r\n        let finalValue = inputValue.trim()\r\n        if (finalValue && /^\\d+$/.test(finalValue)) {\r\n            finalValue = `COTIZ.N-${finalValue}-26`\r\n        } else if (finalValue.startsWith(\"COTIZACION-\")) {\r\n            finalValue = finalValue.replace(\"COTIZACION-\", \"COTIZ.N-\")\r\n        }\r\n\r\n        if (finalValue !== value) {\r\n            table.options.meta?.updateData(original.id, id, finalValue)\r\n        }\r\n    }\r\n\r\n    const onKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\r\n        if (e.key === 'Enter') {\r\n            e.preventDefault(); e.currentTarget.blur()\r\n            setTimeout(() => {\r\n                const allInputs = Array.from(document.querySelectorAll('input:not([type=\"hidden\"]), textarea, select')) as HTMLElement[];\r\n                const currentIndex = allInputs.indexOf(e.target as HTMLElement);\r\n                if (currentIndex !== -1 && currentIndex < allInputs.length - 1) {\r\n                    allInputs[currentIndex + 1].focus();\r\n                    if (allInputs[currentIndex + 1] instanceof HTMLInputElement) (allInputs[currentIndex + 1] as HTMLInputElement).select();\r\n                }\r\n            }, 0)\r\n        }\r\n    }\r\n\r\n    if (!canEdit) {\r\n        return (\r\n            <div className=\"w-full h-full flex items-center px-1 text-sm text-zinc-900 font-medium bg-zinc-50/50 cursor-not-allowed\" title=\"Solo Comercial puede editar\">\r\n                {value || <span className=\"text-zinc-300 italic\">-</span>}\r\n            </div>\r\n        )\r\n    }\r\n\r\n    if (isEditing) {\r\n        return (\r\n            <input\r\n                autoFocus\r\n                value={inputValue}\r\n                onChange={e => setInputValue(e.target.value)}\r\n                onBlur={onBlur}\r\n                onKeyDown={onKeyDown}\r\n                className=\"w-full h-full bg-white border border-blue-300 rounded text-sm p-1 text-zinc-900 font-medium\"\r\n                placeholder=\"Ej: 123\"\r\n            />\r\n        )\r\n    }\r\n\r\n    return (\r\n        <div\r\n            onClick={() => { setInputValue(value || \"\"); setIsEditing(true); }}\r\n            className=\"w-full h-full cursor-pointer hover:bg-slate-50 flex items-center px-1 text-sm truncate text-zinc-900 font-medium\"\r\n            title={value || \"Click para editar (Comercial)\"}\r\n        >\r\n            {value || <span className=\"text-zinc-300 italic\">...</span>}\r\n        </div>\r\n    )\r\n})\r\nCotizacionCell.displayName = \"CotizacionCell\"\r\n\r\n// Status Cell (Estado de trabajo) - blocks lector role\r\nconst StatusCell = React.memo(({ getValue, row: { original }, column: { id }, table }: EditableCellProps<ProgramacionServicio>) => {\r\n    const value = getValue() as string\r\n\r\n    // --- Column-based permissions: lector CANNOT edit estado_trabajo ---\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const meta = table.options.meta as any\r\n    const userRole = (meta?.userRole || \"\").toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n\r\n    const getCanEditStatus = (): boolean => {\r\n        if (userRole === 'admin') return true\r\n        // lector cannot edit anything\r\n        if (userRole === 'laboratorio_lector' || userRole.includes('lector')) return false\r\n        // tipificador CAN edit estado\r\n        if (userRole === 'laboratorio_tipificador' || (userRole.includes('laboratorio') && userRole.includes('tipificador'))) return true\r\n        // vendor CAN edit estado\r\n        if (userRole === 'vendor' || userRole.includes('vendedor') || userRole.includes('asesor') || userRole.includes('comercial')) return true\r\n        // administrativo CAN edit estado\r\n        if (userRole === 'administrativo') return true\r\n        return meta?.canWrite ?? false\r\n    }\r\n    const canEdit = getCanEditStatus()\r\n\r\n    const handleChange = (newValue: string) => {\r\n        if (!canEdit) return\r\n        if (newValue !== value) table.options.meta?.updateData(original.id, id, newValue)\r\n    }\r\n\r\n    return (\r\n        <div className={cn(\"text-[13px] font-medium\", !canEdit && \"cursor-not-allowed opacity-60\")}>\r\n            <StatusSelect value={value} onChange={handleChange} disabled={!canEdit} />\r\n        </div>\r\n    )\r\n})\r\nStatusCell.displayName = \"StatusCell\"\r\n\r\n// Autorizacion Cell (Dropdown)\r\n// Granular: Depends on permissions.administracion.write\r\nconst AutorizacionCell = React.memo(({ getValue, row: { index, original }, column: { id }, table }: EditableCellProps<ProgramacionServicio>) => {\r\n    const value = getValue() as string\r\n\r\n    // --- Column-based permissions: tipificador CANNOT edit autorizacion_lab ---\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const meta = table.options.meta as any\r\n    const userRole = (meta?.userRole || \"\").toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n\r\n    const getCanEditAutorizacion = (): boolean => {\r\n        const viewMode = meta?.viewMode || \"\"\r\n        if (userRole === 'admin') {\r\n            if (viewMode === 'LAB') return false\r\n            return true\r\n        }\r\n        // tipificador cannot edit autorizacion\r\n        if (userRole === 'laboratorio_tipificador' || (userRole.includes('laboratorio') && userRole.includes('tipificador'))) return false\r\n        // lector cannot edit anything\r\n        if (userRole === 'laboratorio_lector' || userRole.includes('lector')) return false\r\n        // vendor/comercial CANNOT edit autorizacion - solo administrativo\r\n        if (userRole === 'vendor' || userRole.includes('vendedor') || userRole.includes('asesor') || userRole.includes('comercial')) return false\r\n        // administrativo CAN edit autorizacion\r\n        if (userRole === 'administrativo') return true\r\n        return meta?.canWrite ?? false\r\n    }\r\n    const canEdit = getCanEditAutorizacion()\r\n\r\n    const handleChange = (newValue: string) => {\r\n        if (!canEdit) return\r\n        table.options.meta?.updateData(original.id, id, newValue)\r\n    }\r\n\r\n    return (\r\n        <div className={cn(\"w-full h-full flex items-center justify-center p-1\", !canEdit && \"cursor-not-allowed\")}>\r\n            <AuthorizationSelect\r\n                value={value}\r\n                onChange={handleChange}\r\n                disabled={!canEdit}\r\n            />\r\n        </div>\r\n    )\r\n})\r\nAutorizacionCell.displayName = \"AutorizacionCell\"\r\n\r\nconst PaymentStatusCell = React.memo(({ getValue, row, column: { id }, table }: EditableCellProps<ProgramacionServicio>) => {\r\n    const value = getValue() as string\r\n\r\n    // --- Column-based permissions: vendor CANNOT edit estado_pago ---\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const meta = table.options.meta as any\r\n    const userRole = (meta?.userRole || \"\").toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n\r\n    const getCanEditPayment = (): boolean => {\r\n        const viewMode = meta?.viewMode || \"\"\r\n        if (userRole === 'admin') {\r\n            if (viewMode === 'COM') return false\r\n            return true\r\n        }\r\n        // vendor cannot edit estado_pago\r\n        if (userRole === 'vendor' || userRole.includes('vendedor') || userRole.includes('asesor') || userRole.includes('comercial')) return false\r\n        // lector cannot edit anything\r\n        if (userRole === 'laboratorio_lector' || userRole.includes('lector')) return false\r\n        // tipificador CAN edit estado_pago\r\n        if (userRole === 'laboratorio_tipificador' || (userRole.includes('laboratorio') && userRole.includes('tipificador'))) return true\r\n        // administrativo CAN edit estado_pago\r\n        if (userRole === 'administrativo') return true\r\n        return meta?.canWrite ?? false\r\n    }\r\n    const canEdit = getCanEditPayment()\r\n\r\n    const onStatusChange = (newValue: string) => {\r\n        if (!canEdit) return\r\n        table.options.meta?.updateData(row.original.id, id, newValue)\r\n    }\r\n    return (\r\n        <div className={cn(\"w-full h-full flex items-center justify-center p-1\", !canEdit && \"cursor-not-allowed\")}>\r\n            <PaymentSelect value={value} onChange={onStatusChange} disabled={!canEdit} />\r\n        </div>\r\n    )\r\n})\r\nPaymentStatusCell.displayName = \"PaymentStatusCell\"\r\n\r\nexport const columnsLab: ColumnDef<ProgramacionServicio>[] = [\r\n    {\r\n        accessorKey: \"item_numero\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"ITEM\" />,\r\n        size: 69,\r\n        minSize: 69,\r\n        maxSize: 69,\r\n        enablePinning: true,\r\n        enableResizing: false,\r\n        cell: info => <div className=\"text-zinc-600 font-mono text-sm text-center bg-white h-full flex items-center justify-center\">{info.getValue() as string}</div>\r\n    },\r\n    {\r\n        accessorKey: \"recep_numero\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"RECEP\" />,\r\n        size: 78,\r\n        minSize: 78,\r\n        maxSize: 78,\r\n        enablePinning: true,\r\n        enableResizing: false,\r\n        cell: EditableCell,\r\n    },\r\n    {\r\n        accessorKey: \"ot\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"OT\" />,\r\n        size: 125,\r\n        minSize: 125,\r\n        maxSize: 125,\r\n        enablePinning: true,\r\n        enableResizing: false,\r\n        cell: OTCell,\r\n    },\r\n    {\r\n        accessorKey: \"codigo_muestra\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"CODIGO MUESTRA\" />,\r\n        size: 140,\r\n        minSize: 140,\r\n        maxSize: 140,\r\n        enablePinning: true,\r\n        enableResizing: false,\r\n        cell: CodigoMuestraCell,\r\n    },\r\n    {\r\n        accessorKey: \"fecha_recepcion\",\r\n        header: ({ column }) => <SortableHeader column={column} title={`FECHA\\nRECEPCION`} />,\r\n        size: 115,\r\n        minSize: 115,\r\n        maxSize: 115,\r\n        enablePinning: true,\r\n        enableResizing: false,\r\n        cell: SmartDateCell,\r\n    },\r\n    {\r\n        accessorKey: \"fecha_inicio\",\r\n        header: ({ column }) => <SortableHeader column={column} title={`FECHA\\nINICIO`} />,\r\n        size: 110,\r\n        minSize: 110,\r\n        maxSize: 110,\r\n        enablePinning: true,\r\n        enableResizing: false,\r\n        cell: SmartDateCell,\r\n    },\r\n    {\r\n        accessorKey: \"fecha_entrega_estimada\",\r\n        header: ({ column }) => <SortableHeader column={column} title={`FECHA\\nENTREGA`} />,\r\n        size: 110,\r\n        minSize: 110,\r\n        maxSize: 110,\r\n        enablePinning: true,\r\n        enableResizing: false,\r\n        cell: SmartDateCell,\r\n    },\r\n    {\r\n        accessorKey: \"cliente_nombre\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"CLIENTE\" />,\r\n        size: 160,\r\n        minSize: 160,\r\n        maxSize: 160,\r\n        enablePinning: true,\r\n        enableResizing: false,\r\n        cell: (props) => (\r\n            <div className=\"line-clamp-2 leading-tight\">\r\n                <EditableCell {...props} className=\"text-[12.5px] leading-3 text-zinc-900 font-medium\" />\r\n            </div>\r\n        )\r\n    },\r\n    {\r\n        accessorKey: \"proyecto\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"PROYECTO\" />,\r\n        size: 150,\r\n        minSize: 100,\r\n        maxSize: 400,\r\n        enableResizing: true,\r\n        cell: (props) => <EditableCell {...props} className=\"text-zinc-900\" />,\r\n    },\r\n    {\r\n        accessorKey: \"descripcion_servicio\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"DESCRIPCION DEL SERVICIO\" />,\r\n        size: 157,\r\n        minSize: 157,\r\n        maxSize: 157,\r\n        enablePinning: true,\r\n        enableResizing: false,\r\n        cell: (props) => <EditableCell {...props} className=\"text-zinc-900\" />,\r\n    },\r\n    {\r\n        accessorKey: \"entrega_real\",\r\n        header: ({ column }) => <SortableHeader column={column} title={`ENTREGA\\nREAL`} />,\r\n        size: 130,\r\n        minSize: 100,\r\n        maxSize: 300,\r\n        enableResizing: true,\r\n        cell: SmartDateCell,\r\n    },\r\n    {\r\n        accessorKey: \"estado_trabajo\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"ESTADO\" className=\"text-base font-semibold\" />,\r\n        size: 180,\r\n        minSize: 160,\r\n        maxSize: 280,\r\n        enableResizing: true,\r\n        cell: StatusCell,\r\n    },\r\n    {\r\n        accessorKey: \"cotizacion_lab\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"COTIZACION\" />,\r\n        size: 150,\r\n        minSize: 120,\r\n        maxSize: 300,\r\n        enableResizing: true,\r\n        cell: CotizacionCell,\r\n    },\r\n    {\r\n        accessorKey: \"autorizacion_lab\",\r\n        header: ({ column }) => (\r\n            <div className=\"flex flex-col items-center\">\r\n                <SortableHeader column={column} title=\"AUTORIZADO\" className=\"bg-indigo-50/50 text-indigo-900\" />\r\n                <span className=\"text-[9px] text-indigo-500 font-medium -mt-1\">ADMINISTRACI├ôN</span>\r\n            </div>\r\n        ),\r\n        size: 130,\r\n        minSize: 100,\r\n        maxSize: 200,\r\n        enableResizing: true,\r\n        cell: AutorizacionCell,\r\n    },\r\n\r\n    {\r\n        accessorKey: \"nota_admin\",\r\n        header: ({ column }) => <SortableHeader column={column} title=\"NOTA\" className=\"text-base font-semibold\" />,\r\n        size: 350,\r\n        minSize: 250,\r\n        maxSize: 700,\r\n        enableResizing: true,\r\n        cell: ({ getValue, row, column, table }) => (\r\n            <EditableCell getValue={getValue} row={row} column={column} table={table} className=\"text-[13px] text-zinc-900\" />\r\n        ),\r\n    },\r\n    {\r\n        accessorKey: \"dias_atraso_lab\",\r\n        header: ({ column }) => <SortableHeader column={column} title={`DIAS\\nATRASO`} />,\r\n        size: 80,\r\n        minSize: 60,\r\n        maxSize: 90,\r\n        enableResizing: true,\r\n        filterFn: (row, columnId, filterValue) => {\r\n            if (!filterValue) return true\r\n            const val = row.getValue(columnId) as number\r\n            return val > 0\r\n        },\r\n        cell: ({ row }) => {\r\n            const estimatedDateStr = row.original.fecha_entrega_estimada\r\n            const realDateStr = row.original.entrega_real\r\n\r\n            if (!estimatedDateStr) return <div className=\"text-zinc-300 text-center\">-</div>\r\n\r\n            const estimated = new Date(estimatedDateStr)\r\n            const real = realDateStr ? new Date(realDateStr) : new Date()\r\n\r\n            estimated.setHours(0, 0, 0, 0)\r\n            real.setHours(0, 0, 0, 0)\r\n\r\n            const diffTime = real.getTime() - estimated.getTime()\r\n            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24))\r\n\r\n            if (!realDateStr && diffDays <= 0) {\r\n                return <div className=\"text-center font-mono text-zinc-900\">0</div>\r\n            }\r\n\r\n            return (\r\n                <div className={`text-center font-mono ${diffDays > 0 ? \"text-red-600 font-bold\" : \"text-zinc-900\"}`}>\r\n                    {diffDays > 0 ? `+${diffDays}` : diffDays}\r\n                </div>\r\n            )\r\n        }\r\n    },\r\n    {\r\n        accessorKey: \"motivo_dias_atraso_lab\",\r\n        header: ({ column }) => <SortableHeader column={column} title={`MOTIVO\\nATRASO`} />,\r\n        size: 140,\r\n        minSize: 120,\r\n        maxSize: 300,\r\n        enableResizing: true,\r\n        cell: (props) => <EditableCell {...props} className=\"text-zinc-900\" />,\r\n    },\r\n    {\r\n        accessorKey: \"evidencia_envio_recepcion\",\r\n        header: ({ column }) => <SortableHeader column={column} title={`EVID.\\nRECEP.`} />,\r\n        size: 70,\r\n        minSize: 50,\r\n        maxSize: 70,\r\n        enableResizing: true,\r\n        cell: (props) => <EditableCell {...props} className=\"text-center text-[11px] font-bold text-zinc-900 uppercase\" />,\r\n    },\r\n    {\r\n        accessorKey: \"envio_informes\",\r\n        header: ({ column }) => <SortableHeader column={column} title={`ENVIO\\nINF.`} />,\r\n        size: 70,\r\n        minSize: 50,\r\n        maxSize: 70,\r\n        enableResizing: true,\r\n        cell: (props) => <EditableCell {...props} className=\"text-center text-[11px] font-bold text-zinc-900 uppercase\" />,\r\n    },\r\n]\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\components\\datagrid\\data-table.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TData' is defined but never used.","line":31,"column":25,"nodeType":"Identifier","messageId":"unusedVar","endLine":31,"endColumn":30},{"ruleId":"react-hooks/incompatible-library","severity":1,"message":"Compilation Skipped: Use of incompatible library\n\nThis API returns functions which cannot be memoized without leading to stale UI. To prevent this, by default React Compiler will skip memoizing this component/hook. However, you may see issues if values from this API are passed to other components/hooks that are memoized.\n\nC:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\components\\datagrid\\data-table.tsx:76:19\n  74 |     })\n  75 |\n> 76 |     const table = useReactTable({\n     |                   ^^^^^^^^^^^^^ TanStack Table's `useReactTable()` API returns functions that cannot be memoized safely\n  77 |         data,\n  78 |         columns,\n  79 |         columnResizeMode: \"onChange\",","line":76,"column":19,"nodeType":null,"endLine":76,"endColumn":32}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":36,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1013,1016],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1013,1016],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":50,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":50,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1443,1446],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1443,1446],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport React, { useRef } from \"react\"\r\nimport {\r\n    ColumnDef,\r\n    flexRender,\r\n    getCoreRowModel,\r\n    useReactTable,\r\n    getPaginationRowModel,\r\n    getSortedRowModel,\r\n    getFilteredRowModel,\r\n    SortingState,\r\n    ColumnFiltersState,\r\n    VisibilityState,\r\n    RowData,\r\n} from \"@tanstack/react-table\"\r\nimport { useVirtualizer } from \"@tanstack/react-virtual\"\r\nimport { cn } from \"@/lib/utils\"\r\n// import { Button } from \"@/components/ui/button\" \r\nimport {\r\n    ChevronLeft,\r\n    ChevronRight,\r\n    ChevronsLeft,\r\n    ChevronsRight,\r\n    Loader2\r\n} from \"lucide-react\"\r\nimport { GhostRow } from \"./ghost-row\"\r\n\r\n// Extend TableMeta to include our custom properties\r\ndeclare module '@tanstack/react-table' {\r\n    interface TableMeta<TData extends RowData> {\r\n        updateData: (rowId: string, columnId: string, value: unknown) => void\r\n        userRole?: string\r\n        canWrite?: boolean\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        permissions?: any\r\n        viewMode?: string\r\n    }\r\n}\r\n\r\ninterface DataTableProps<TData, TValue> {\r\n    columns: ColumnDef<TData, TValue>[]\r\n    data: TData[]\r\n    loading?: boolean\r\n    onUpdate?: (rowId: string, field: string, value: unknown) => void\r\n    onInsert?: (data: Partial<TData>) => Promise<void>\r\n    userRole?: string\r\n    canWrite?: boolean\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    permissions?: any\r\n    viewMode?: string\r\n}\r\n\r\nexport function DataTable<TData, TValue>({\r\n    columns,\r\n    data,\r\n    loading,\r\n    onUpdate,\r\n    onInsert,\r\n    userRole,\r\n    canWrite,\r\n    permissions,\r\n    viewMode\r\n}: DataTableProps<TData, TValue>) {\r\n    const [sorting, setSorting] = React.useState<SortingState>([])\r\n    const [columnFilters, setColumnFilters] = React.useState<ColumnFiltersState>([])\r\n    const [columnVisibility, setColumnVisibility] = React.useState<VisibilityState>({})\r\n    const [globalFilter, setGlobalFilter] = React.useState(\"\")\r\n\r\n    // Pagination for High Volume: Default 500\r\n    const [pagination, setPagination] = React.useState({\r\n        pageIndex: 0,\r\n        pageSize: 500,\r\n    })\r\n\r\n    const table = useReactTable({\r\n        data,\r\n        columns,\r\n        columnResizeMode: \"onChange\",\r\n        getCoreRowModel: getCoreRowModel(),\r\n        getPaginationRowModel: getPaginationRowModel(),\r\n        getSortedRowModel: getSortedRowModel(),\r\n        getFilteredRowModel: getFilteredRowModel(),\r\n        state: {\r\n            sorting,\r\n            columnFilters,\r\n            columnVisibility,\r\n            globalFilter,\r\n            pagination,\r\n        },\r\n        initialState: {\r\n            columnPinning: {\r\n                left: [\r\n                    \"item_numero\",\r\n                    \"recep_numero\",\r\n                    \"ot\",\r\n                    \"codigo_muestra\",\r\n                    \"fecha_recepcion\",\r\n                    \"fecha_inicio\",\r\n                    \"fecha_entrega_estimada\",\r\n                    \"cliente_nombre\",\r\n                    \"proyecto\"\r\n                ]\r\n            }\r\n        },\r\n        onSortingChange: setSorting,\r\n        onColumnFiltersChange: setColumnFilters,\r\n        onGlobalFilterChange: setGlobalFilter,\r\n        onColumnVisibilityChange: setColumnVisibility,\r\n        onPaginationChange: setPagination,\r\n        meta: {\r\n            updateData: (rowId: string, columnId: string, value: unknown) => {\r\n                if (rowId && onUpdate) {\r\n                    onUpdate(rowId, columnId, value)\r\n                }\r\n            },\r\n            userRole: userRole || '',\r\n            canWrite: canWrite ?? false,\r\n            permissions: permissions || null,\r\n            viewMode: viewMode || ''\r\n        },\r\n    })\r\n\r\n    // --- Virtualization ---\r\n    const tableContainerRef = useRef<HTMLDivElement>(null)\r\n    const { rows } = table.getRowModel()\r\n\r\n    const rowVirtualizer = useVirtualizer({\r\n        count: rows.length,\r\n        getScrollElement: () => tableContainerRef.current,\r\n        estimateSize: () => 40, // Base row height\r\n        overscan: 20, // Buffer rows\r\n    })\r\n\r\n    return (\r\n        <div className=\"flex flex-col h-full bg-white font-sans text-sm\">\r\n            {/* Toolbar Area */}\r\n            <div className=\"flex items-center justify-between p-2 border-b border-zinc-200 bg-white gap-2\">\r\n                <div className=\"flex items-center gap-2 flex-1 flex-wrap\">\r\n                    <input\r\n                        placeholder=\"Buscar en todo...\"\r\n                        value={globalFilter ?? \"\"}\r\n                        onChange={(event) => setGlobalFilter(event.target.value)}\r\n                        className=\"h-8 w-[200px] lg:w-[250px] border border-zinc-200 rounded-md px-3 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 bg-zinc-50 text-zinc-900 placeholder:text-zinc-400\"\r\n                    />\r\n\r\n                    {/* Filter for Fecha de Entrega (Lab or Comercial) */}\r\n                    {(table.getAllColumns().find(c => c.id === \"fecha_entrega_estimada\") || table.getAllColumns().find(c => c.id === \"fecha_entrega_com\")) && (\r\n                        <input\r\n                            type=\"date\"\r\n                            className=\"h-8 border border-zinc-200 rounded-md px-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-zinc-900 cursor-pointer hover:bg-zinc-50\"\r\n                            onChange={e => {\r\n                                const val = e.target.value\r\n                                // Try to filter both potential date columns if they exist\r\n                                table.getColumn(\"fecha_entrega_estimada\")?.setFilterValue(val)\r\n                                table.getColumn(\"fecha_entrega_com\")?.setFilterValue(val)\r\n                            }}\r\n                            title=\"Filtrar por Fecha de Entrega\"\r\n                        />\r\n                    )}\r\n\r\n                    {/* Status Filter */}\r\n                    {table.getAllColumns().find(c => c.id === \"estado_trabajo\") && (\r\n                        <select\r\n                            className=\"h-8 border border-zinc-200 rounded-md px-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-zinc-900 cursor-pointer hover:bg-zinc-50\"\r\n                            onChange={e => table.getColumn(\"estado_trabajo\")?.setFilterValue(e.target.value === \"TODOS\" ? \"\" : e.target.value)}\r\n                        >\r\n                            <option value=\"TODOS\">Estado: Todos</option>\r\n                            <option value=\"PENDIENTE\">Pendiente</option>\r\n                            <option value=\"PROCESO\">En Proceso</option>\r\n                            <option value=\"INFORME LISTO\">Informe Listo</option>\r\n                            <option value=\"ENTREGADO\">Entregar</option>\r\n                        </select>\r\n                    )}\r\n\r\n                    {/* Authorization Filter (Admin/Lab) */}\r\n                    {table.getAllColumns().find(c => c.id === \"autorizacion_lab\") && (\r\n                        <select\r\n                            className=\"h-8 border border-zinc-200 rounded-md px-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 bg-indigo-50 text-indigo-900 cursor-pointer hover:bg-indigo-100 font-medium\"\r\n                            onChange={e => table.getColumn(\"autorizacion_lab\")?.setFilterValue(e.target.value === \"TODOS\" ? \"\" : e.target.value)}\r\n                        >\r\n                            <option value=\"TODOS\">Autorizaci├│n: Todas</option>\r\n                            <option value=\"ENTREGADO\">Entregar</option>\r\n                            <option value=\"NO ENTREGADO\">No Entregar</option>\r\n                        </select>\r\n                    )}\r\n\r\n                    {/* Payment Status Filter (Admin) - Using 'envio_informes' as field */}\r\n                    {table.getAllColumns().find(c => c.id === \"envio_informes\") && (\r\n                        <select\r\n                            className=\"h-8 border border-zinc-200 rounded-md px-2 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 bg-emerald-50 text-emerald-900 cursor-pointer hover:bg-emerald-100 font-medium\"\r\n                            onChange={e => table.getColumn(\"envio_informes\")?.setFilterValue(e.target.value === \"TODOS\" ? \"\" : e.target.value)}\r\n                        >\r\n                            <option value=\"TODOS\">Pago: Todos</option>\r\n                            <option value=\"PENDIENTE\">Pendiente</option>\r\n                            <option value=\"EN PROCESO\">En Proceso</option>\r\n                            <option value=\"PAGADO\">Pagado</option>\r\n                        </select>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            {/* Table Area with Virtualization */}\r\n            {/* Height must be fixed for virtualization. h-full takes parent's flex-1 height */}\r\n            <div\r\n                ref={tableContainerRef}\r\n                className=\"flex-1 overflow-auto relative bg-zinc-50 border-b border-zinc-200 scrollbar-thin scrollbar-thumb-zinc-300 scrollbar-track-transparent\"\r\n                style={{ height: '100%', contain: 'strict', zoom: '85%' }}\r\n            >\r\n                <table\r\n                    className=\"border-collapse\"\r\n                    style={{ width: table.getTotalSize(), tableLayout: 'fixed' }}\r\n                >\r\n                    <thead className=\"sticky top-0 z-40 bg-white shadow-sm h-10 text-sm\">\r\n                        {table.getHeaderGroups().map((headerGroup) => (\r\n                            <tr key={headerGroup.id} className=\"border-b border-zinc-200\">\r\n                                {headerGroup.headers.map((header) => {\r\n                                    const isPinned = header.column.getIsPinned()\r\n                                    const isLastPinned = isPinned === \"left\" && header.column.id === \"descripcion_servicio\"\r\n\r\n                                    return (\r\n                                        <th\r\n                                            key={header.id}\r\n                                            style={{\r\n                                                width: header.getSize(),\r\n                                                left: isPinned ? header.column.getStart(\"left\") : undefined,\r\n                                                position: isPinned ? \"sticky\" : \"relative\",\r\n                                                zIndex: isPinned ? 20 : 0,\r\n                                                boxSizing: \"border-box\",\r\n                                            }}\r\n                                            className={cn(\r\n                                                \"px-2 py-2 text-left bg-[#f4f4f5] select-none relative group\",\r\n                                                isPinned ? \"shadow-[inset_-1px_0_0_0_#d4d4d8]\" : \"shadow-[inset_-1px_0_0_0_#e4e4e7]\",\r\n                                                isLastPinned && \"shadow-[inset_-1px_0_0_0_#d4d4d8,4px_0_5px_-2px_rgba(0,0,0,0.1)]\"\r\n                                            )}\r\n                                        >\r\n                                            {header.isPlaceholder ? null : flexRender(header.column.columnDef.header, header.getContext())}\r\n                                        </th>\r\n                                    )\r\n                                })}\r\n                            </tr>\r\n                        ))}\r\n                    </thead>\r\n                    <tbody className=\"bg-white\">\r\n\r\n                        {/* Virtual Items */}\r\n                        {rowVirtualizer.getVirtualItems().length === 0 ? (\r\n                            <tr>\r\n                                <td colSpan={columns.length} className=\"h-24 text-center\">\r\n                                    No results.\r\n                                </td>\r\n                            </tr>\r\n                        ) : (\r\n                            <>\r\n                                {/* Top Spacer */}\r\n                                {rowVirtualizer.getVirtualItems()[0].index > 0 && (\r\n                                    <tr>\r\n                                        <td style={{ height: `${rowVirtualizer.getVirtualItems()[0].start - 0}px` }} />\r\n                                    </tr>\r\n                                )}\r\n\r\n                                {rowVirtualizer.getVirtualItems().map((virtualRow) => {\r\n                                    const row = rows[virtualRow.index]\r\n                                    return (\r\n\r\n                                        <tr\r\n                                            key={row.id}\r\n                                            data-index={virtualRow.index}\r\n                                            ref={rowVirtualizer.measureElement} // Enable dynamic measurement\r\n                                            className=\"hover:bg-blue-100/50 transition-colors group\" // Removed row striping, kept hover\r\n                                            style={{\r\n                                                // Removed fixed height logic, let content drive height\r\n                                            }}\r\n                                        >\r\n                                            {row.getVisibleCells().map((cell) => {\r\n                                                const isPinned = cell.column.getIsPinned()\r\n                                                const isLastPinned = isPinned === \"left\" && cell.column.id === \"descripcion_servicio\"\r\n                                                const isEvenRow = virtualRow.index % 2 === 0\r\n\r\n                                                return (\r\n                                                    <td\r\n                                                        key={cell.id}\r\n                                                        style={{\r\n                                                            width: cell.column.getSize(),\r\n                                                            left: isPinned ? cell.column.getStart(\"left\") : undefined,\r\n                                                            position: isPinned ? \"sticky\" : \"relative\",\r\n                                                            zIndex: isPinned ? 10 : 0,\r\n                                                            boxSizing: \"border-box\",\r\n                                                        }}\r\n                                                        className={cn(\r\n                                                            \"px-2 py-1.5 align-middle\",\r\n                                                            isPinned\r\n                                                                ? (isEvenRow ? \"bg-blue-50 hover:!bg-blue-200\" : \"bg-white hover:!bg-blue-200\")\r\n                                                                : (isEvenRow ? \"bg-blue-50/80 hover:!bg-blue-200\" : \"bg-white hover:!bg-blue-200\"),\r\n                                                            isPinned ? \"shadow-[inset_-1px_0_0_0_#d4d4d8,0_1px_0_0_#e4e4e7]\" : \"shadow-[inset_-1px_0_0_0_#e4e4e7,0_1px_0_0_#e4e4e7]\",\r\n                                                            isLastPinned && \"shadow-[inset_-1px_0_0_0_#d4d4d8,0_1px_0_0_#e4e4e7,4px_0_5px_-2px_rgba(0,0,0,0.05)]\"\r\n                                                        )}\r\n                                                    >\r\n                                                        {flexRender(cell.column.columnDef.cell, cell.getContext())}\r\n                                                    </td>\r\n                                                )\r\n                                            })}\r\n                                        </tr>\r\n                                    )\r\n                                })}\r\n\r\n                                {/* Bottom Spacer */}\r\n                                {rowVirtualizer.getVirtualItems().length > 0 && (\r\n                                    <tr>\r\n                                        <td style={{\r\n                                            height: `${rowVirtualizer.getTotalSize() - rowVirtualizer.getVirtualItems()[rowVirtualizer.getVirtualItems().length - 1].end}px`\r\n                                        }} />\r\n                                    </tr>\r\n                                )}\r\n                            </>\r\n                        )}\r\n\r\n                        {/* Ghost Row - At bottom like Excel */}\r\n                        {onInsert && <GhostRow table={table} onInsert={onInsert} />}\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n\r\n            {/* Pagination Controls */}\r\n            <div className=\"flex items-center justify-between px-2 py-2 border-t border-zinc-200 bg-white\">\r\n                <div className=\"text-xs text-zinc-500\">\r\n                    {table.getFilteredSelectedRowModel().rows.length} of{\" \"}\r\n                    {table.getFilteredRowModel().rows.length} row(s) selected.\r\n                </div>\r\n                <div className=\"flex items-center space-x-2\">\r\n                    <button\r\n                        className=\"p-1 rounded hover:bg-zinc-100 disabled:opacity-50\"\r\n                        onClick={() => table.setPageIndex(0)}\r\n                        disabled={!table.getCanPreviousPage()}\r\n                    >\r\n                        <ChevronsLeft className=\"h-4 w-4\" />\r\n                    </button>\r\n                    <button\r\n                        className=\"p-1 rounded hover:bg-zinc-100 disabled:opacity-50\"\r\n                        onClick={() => table.previousPage()}\r\n                        disabled={!table.getCanPreviousPage()}\r\n                    >\r\n                        <ChevronLeft className=\"h-4 w-4\" />\r\n                    </button>\r\n                    <span className=\"text-xs text-zinc-600\">\r\n                        Page {table.getState().pagination.pageIndex + 1} of{\" \"}\r\n                        {table.getPageCount()}\r\n                    </span>\r\n                    <button\r\n                        className=\"p-1 rounded hover:bg-zinc-100 disabled:opacity-50\"\r\n                        onClick={() => table.nextPage()}\r\n                        disabled={!table.getCanNextPage()}\r\n                    >\r\n                        <ChevronRight className=\"h-4 w-4\" />\r\n                    </button>\r\n                    <button\r\n                        className=\"p-1 rounded hover:bg-zinc-100 disabled:opacity-50\"\r\n                        onClick={() => table.setPageIndex(table.getPageCount() - 1)}\r\n                        disabled={!table.getCanNextPage()}\r\n                    >\r\n                        <ChevronsRight className=\"h-4 w-4\" />\r\n                    </button>\r\n                    <select\r\n                        value={table.getState().pagination.pageSize}\r\n                        onChange={e => {\r\n                            table.setPageSize(Number(e.target.value))\r\n                        }}\r\n                        className=\"h-6 w-16 text-xs border border-zinc-200 rounded\"\r\n                    >\r\n                        {[100, 500, 1000, 2000, 5000, 8000].map(pageSize => (\r\n                            <option key={pageSize} value={pageSize}>\r\n                                {pageSize}\r\n                            </option>\r\n                        ))}\r\n                    </select>\r\n                </div>\r\n            </div>\r\n\r\n            {loading && (\r\n                <div className=\"absolute inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center z-50\">\r\n                    <Loader2 className=\"h-8 w-8 text-blue-600 animate-spin\" />\r\n                </div>\r\n            )}\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\components\\datagrid\\ghost-row.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ProgramacionServicio' is defined but never used.","line":4,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":4,"endColumn":30,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"ProgramacionServicio"},"fix":{"range":[125,184],"text":""},"desc":"Remove unused import declaration."}]},{"ruleId":"prefer-const","severity":2,"message":"'y' is never reassigned. Use 'const' instead.","line":120,"column":25,"nodeType":"Identifier","messageId":"useConst","endLine":120,"endColumn":26,"fix":{"range":[4762,4778],"text":"const y = parts[2]"}}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import React from \"react\"\r\nimport { Table as TanStackTable } from \"@tanstack/react-table\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { ProgramacionServicio } from \"@/types/programacion\"\r\nimport { z } from \"zod\"\r\nimport { StatusSelect } from \"./status-select\"\r\nimport { PaymentSelect } from \"./payment-select\"\r\nimport { AuthorizationSelect } from \"./authorization-select\"\r\n\r\n// Zod Schema for validation\r\nconst insertSchema = z.object({\r\n    recep_numero: z.string().min(1, \"Requerido\"),\r\n    ot: z.string().min(1, \"Requerido\"),\r\n    // Add other validations as needed\r\n})\r\n\r\ninterface GhostRowProps<TData> {\r\n    table: TanStackTable<TData>\r\n    onInsert: (data: Partial<TData>) => Promise<void>\r\n}\r\n\r\nexport function GhostRow<TData>({ table, onInsert }: GhostRowProps<TData>) {\r\n    const [newData, setNewData] = React.useState<Partial<TData>>({})\r\n    const [errors, setErrors] = React.useState<Record<string, string>>({})\r\n    const [isSubmitting, setIsSubmitting] = React.useState(false)\r\n\r\n    const handleChange = (columnId: string, value: string) => {\r\n        setNewData(prev => ({ ...prev, [columnId]: value }))\r\n        // Clear error on change\r\n        if (errors[columnId]) {\r\n            setErrors(prev => {\r\n                const newErrors = { ...prev }\r\n                delete newErrors[columnId]\r\n                return newErrors\r\n            })\r\n        }\r\n    }\r\n\r\n    const handleBlur = (columnId: string, value: string) => {\r\n        // Auto-format logic\r\n        if (!value) return\r\n\r\n        let formatted = value.trim()\r\n\r\n        if (columnId === 'recep_numero') {\r\n            // Append -26 if only digits are entered\r\n            if (/^\\d+$/.test(formatted)) {\r\n                formatted = `${formatted}-26`\r\n            }\r\n        }\r\n\r\n        if (columnId === 'ot') {\r\n            // Append -26 if only digits are entered (no LEM)\r\n            if (/^\\d+$/.test(formatted)) {\r\n                formatted = `${formatted}-26`\r\n            }\r\n        }\r\n\r\n        if (columnId === 'cotizacion_lab') {\r\n            // Append COTIZ.N-XXX-26 if only digits are entered\r\n            if (/^\\d+$/.test(formatted)) {\r\n                formatted = `COTIZ.N-${formatted}-26`\r\n            }\r\n        }\r\n\r\n        if (columnId === 'numero_factura') {\r\n            // FXXX-XXXX logic\r\n            if (/^\\d+$/.test(formatted)) {\r\n                const paddedNum = formatted.length < 4 ? formatted.padStart(4, '0') : formatted\r\n                formatted = `F001-${paddedNum}`\r\n            } else if (/^(\\d+)-(\\d+)$/.test(formatted)) {\r\n                const match = formatted.match(/^(\\d+)-(\\d+)$/)\r\n                if (match) {\r\n                    formatted = `F${match[1].padStart(3, '0')}-${match[2].padStart(4, '0')}`\r\n                }\r\n            } else if (/^[fF]\\d+$/.test(formatted)) {\r\n                const nums = formatted.slice(1)\r\n                const paddedNum = nums.length < 4 ? nums.padStart(4, '0') : nums\r\n                formatted = `F001-${paddedNum}`\r\n            }\r\n        }\r\n\r\n\r\n        // Date fields: auto-complete to show DD/MM/YY format (store ISO internally for DB)\r\n        const isDateField = ['fecha_recepcion', 'fecha_inicio', 'fecha_entrega_estimada', 'entrega_real', 'fecha_solicitud_com', 'fecha_entrega_com', 'fecha_pago'].includes(columnId)\r\n        if (isDateField && formatted) {\r\n            let day = ''\r\n            let month = ''\r\n            let yearFull = '2026'\r\n            let yearShort = '26'\r\n\r\n            if (/^\\d{4}$/.test(formatted)) {\r\n                // 1212 ÔåÆ 12/12/26\r\n                day = formatted.slice(0, 2)\r\n                month = formatted.slice(2, 4)\r\n            } else if (/^\\d{6}$/.test(formatted)) {\r\n                // 121226 ÔåÆ 12/12/26\r\n                day = formatted.slice(0, 2)\r\n                month = formatted.slice(2, 4)\r\n                yearShort = formatted.slice(4, 6)\r\n                yearFull = `20${yearShort}`\r\n            } else if (/^\\d{8}$/.test(formatted)) {\r\n                // 12122026 ÔåÆ 12/12/2026\r\n                day = formatted.slice(0, 2)\r\n                month = formatted.slice(2, 4)\r\n                yearFull = formatted.slice(4, 8)\r\n                yearShort = yearFull.slice(-2)\r\n            } else if (/^\\d{3}$/.test(formatted)) {\r\n                // 512 ÔåÆ 05/12/26\r\n                day = formatted.slice(0, 1).padStart(2, '0')\r\n                month = formatted.slice(1, 3)\r\n            } else if (!formatted.includes('-')) {\r\n                const parts = formatted.split(/[./-]/)\r\n                if (parts.length === 2) {\r\n                    day = parts[0]\r\n                    month = parts[1]\r\n                } else if (parts.length === 3) {\r\n                    day = parts[0]\r\n                    month = parts[1]\r\n                    let y = parts[2]\r\n                    if (y.length === 2) {\r\n                        yearShort = y; yearFull = `20${y}`\r\n                    } else {\r\n                        yearFull = y; yearShort = y.slice(-2)\r\n                    }\r\n                }\r\n            }\r\n\r\n            if (day && month) {\r\n                day = day.padStart(2, '0')\r\n                month = month.padStart(2, '0')\r\n                formatted = `${day}/${month}/${yearShort}`\r\n                setNewData(prev => ({\r\n                    ...prev,\r\n                    [columnId]: formatted,\r\n                    [`_${columnId}_iso`]: `${yearFull}-${month}-${day}`\r\n                }))\r\n                return\r\n            }\r\n        }\r\n\r\n        if (formatted !== value) {\r\n            handleChange(columnId, formatted)\r\n        }\r\n    }\r\n\r\n    // Navigate between fields with Enter, submit with Ctrl+Enter\r\n    const handleKeyDown = async (e: React.KeyboardEvent<HTMLInputElement>) => {\r\n        if (e.key === 'Enter') {\r\n            e.preventDefault()\r\n\r\n            // Ctrl+Enter = Submit\r\n            if (e.ctrlKey) {\r\n                await submitRow()\r\n                return\r\n            }\r\n\r\n            // Regular Enter = Navigate to next field\r\n            const allInputs = Array.from(document.querySelectorAll('.ghost-row-input')) as HTMLInputElement[]\r\n            const currentElement = e.currentTarget\r\n            const currentIndex = allInputs.indexOf(currentElement)\r\n\r\n            if (currentIndex !== -1 && currentIndex < allInputs.length - 1) {\r\n                // Move to next field\r\n                allInputs[currentIndex + 1].focus()\r\n                allInputs[currentIndex + 1].select()\r\n            } else {\r\n                // Last field - submit the row\r\n                await submitRow()\r\n            }\r\n        }\r\n    }\r\n\r\n    const submitRow = async () => {\r\n        // Validation\r\n        const validationPayload = {\r\n            recep_numero: newData['recep_numero' as keyof TData],\r\n            ot: newData['ot' as keyof TData]\r\n        }\r\n\r\n        try {\r\n            const result = insertSchema.safeParse(validationPayload)\r\n\r\n            if (!result.success) {\r\n                const formattedErrors: Record<string, string> = {}\r\n                result.error.issues.forEach(issue => {\r\n                    formattedErrors[issue.path[0] as string] = issue.message\r\n                })\r\n                setErrors(formattedErrors)\r\n                return\r\n            }\r\n\r\n            // Submit\r\n            setIsSubmitting(true)\r\n\r\n            // Convert display dates to ISO format for database\r\n            const dateFields = ['fecha_recepcion', 'fecha_inicio', 'fecha_entrega_estimada', 'entrega_real']\r\n            const submitData = { ...newData }\r\n            for (const field of dateFields) {\r\n                const isoKey = `_${field}_iso` as keyof TData\r\n                if (submitData[isoKey as keyof typeof submitData]) {\r\n                    (submitData as Record<string, unknown>)[field] = submitData[isoKey as keyof typeof submitData]\r\n                    delete (submitData as Record<string, unknown>)[isoKey as string]\r\n                }\r\n            }\r\n\r\n            await onInsert(submitData)\r\n            setNewData({}) // Reset\r\n            setErrors({})\r\n        } catch (error) {\r\n            console.error(\"Insert error\", error)\r\n        } finally {\r\n            setIsSubmitting(false)\r\n        }\r\n    }\r\n\r\n    // Get column header titles for placeholders\r\n    const getPlaceholder = (colId: string): string => {\r\n        const placeholders: Record<string, string> = {\r\n            item_numero: \"Auto\",\r\n            recep_numero: \"Recepci├│n\",\r\n            ot: \"OT #\",\r\n            codigo_muestra: \"C├│digo\",\r\n            cliente_nombre: \"Cliente\",\r\n            proyecto: \"Proyecto\",\r\n            descripcion_servicio: \"Descripci├│n\",\r\n            fecha_recepcion: \"DDMM\",\r\n            fecha_inicio: \"DDMM\",\r\n            fecha_entrega: \"DDMM\",\r\n            entrega_real: \"DDMM\",\r\n            cotizacion_lab: \"COTIZ.N-XX-26\",\r\n            numero_factura: \"FXXX-XXXX\",\r\n            estado_trabajo: \"Estado\",\r\n            dias_atraso_lab: \"0\",\r\n            dias_atraso_envio_coti: \"0\",\r\n            nota_lab: \"Nota...\",\r\n            autorizacion_lab: \"-\",\r\n            envio_informes: \"-\",\r\n            estado_pago: \"PENDIENTE\",\r\n        }\r\n        return placeholders[colId] || \"...\"\r\n    }\r\n\r\n    // Get user role and view mode from table meta\r\n    const meta = table.options.meta as { userRole?: string; viewMode?: string } | undefined\r\n    const userRole = meta?.userRole || ''\r\n    const viewMode = meta?.viewMode || ''\r\n\r\n    // Permission check function (similar to columns.tsx)\r\n    const getCanWriteColumn = (columnId: string): boolean => {\r\n        // Role restrictions for ADMIN\r\n        if (userRole === 'admin') {\r\n            if (viewMode === 'LAB') {\r\n                const blockedColumns = ['cotizacion_lab', 'autorizacion_lab']\r\n                if (blockedColumns.includes(columnId)) return false\r\n            }\r\n            if (viewMode === 'COM') {\r\n                const blockedColumns = ['estado_pago']\r\n                if (blockedColumns.includes(columnId)) return false\r\n            }\r\n            if (viewMode === 'ADMIN') {\r\n                const blockedColumns = ['cotizacion_lab']\r\n                if (blockedColumns.includes(columnId)) return false\r\n            }\r\n            return true\r\n        }\r\n\r\n        // Role: laboratorio_lector - Cannot edit anything\r\n        if (userRole === 'laboratorio_lector' || userRole.includes('lector')) {\r\n            return false\r\n        }\r\n\r\n        // Role: laboratorio_tipificador - Can edit everything EXCEPT cotizacion_lab, autorizacion_lab\r\n        if (userRole === 'laboratorio_tipificador' || (userRole.includes('laboratorio') && userRole.includes('tipificador'))) {\r\n            const blockedColumns = ['cotizacion_lab', 'autorizacion_lab']\r\n            if (blockedColumns.includes(columnId)) return false\r\n            return true\r\n        }\r\n\r\n        // Role: vendor - Can edit everything EXCEPT estado_pago\r\n        if (userRole === 'vendor' || userRole.includes('vendedor') || userRole.includes('asesor') || userRole.includes('comercial')) {\r\n            const blockedColumns = ['estado_pago']\r\n            if (blockedColumns.includes(columnId)) return false\r\n            return true\r\n        }\r\n\r\n        // Role: laboratorio - Can edit everything EXCEPT estado_pago\r\n        if (userRole === 'laboratorio') {\r\n            const blockedColumns = ['estado_pago']\r\n            if (blockedColumns.includes(columnId)) return false\r\n            return true\r\n        }\r\n\r\n        // Default: allow editing\r\n        return true\r\n    }\r\n\r\n    return (\r\n        <tr className=\"group hover:bg-blue-100/50 transition-colors\">\r\n            {table.getAllLeafColumns().map((column) => {\r\n                const isPinned = column.getIsPinned()\r\n                const isLastPinned = isPinned === \"left\" && column.id === \"descripcion_servicio\"\r\n                const colId = column.id\r\n                const value = (newData as Record<string, unknown>)[colId] as string || \"\"\r\n                const error = errors[colId]\r\n\r\n                // Read-only logic for IT\r\n                const isReadOnly = colId === 'item_numero'\r\n                const isNumeric = colId === 'dias_atraso_lab' || colId === 'dias_atraso_envio_coti'\r\n                const isStatus = colId === 'estado_trabajo'\r\n                const isPaymentStatus = colId === 'estado_pago'\r\n                const isAutorizacion = colId === 'autorizacion_lab'\r\n\r\n                // Check permissions for this column\r\n                const canWrite = getCanWriteColumn(colId)\r\n\r\n                // Common TD styles matching data-table.tsx\r\n                const tdStyle = {\r\n                    width: column.getSize(),\r\n                    left: isPinned ? column.getStart(\"left\") : undefined,\r\n                    position: isPinned ? \"sticky\" as const : \"relative\" as const,\r\n                    zIndex: isPinned ? 15 : 0,\r\n                    boxSizing: \"border-box\" as const,\r\n                }\r\n\r\n                const tdClassName = cn(\r\n                    \"px-2 py-3 align-middle\",\r\n                    isPinned ? \"bg-white hover:!bg-blue-200\" : \"bg-white\",\r\n                    isPinned ? \"shadow-[inset_-1px_0_0_0_#d4d4d8,0_1px_0_0_#e4e4e7]\" : \"shadow-[inset_-1px_0_0_0_#e4e4e7,0_1px_0_0_#e4e4e7]\",\r\n                    isLastPinned && \"shadow-[inset_-1px_0_0_0_#d4d4d8,0_1px_0_0_#e4e4e7,4px_0_5px_-2px_rgba(0,0,0,0.05)]\"\r\n                )\r\n\r\n                return (\r\n                    <td key={`ghost-${colId}`} style={tdStyle} className={tdClassName}>\r\n                        {isReadOnly ? (\r\n                            <div className=\"px-1 text-zinc-400 italic text-base font-semibold\">+</div>\r\n                        ) : !canWrite ? (\r\n                            <div className=\"w-full text-center text-zinc-300 text-sm select-none italic\">-</div>\r\n                        ) : isStatus ? (\r\n                            <div className=\"w-full h-full flex items-center justify-center\">\r\n                                <StatusSelect value={value} onChange={(val) => handleChange(colId, val)} />\r\n                            </div>\r\n                        ) : isPaymentStatus ? (\r\n                            <div className=\"w-full h-full flex items-center justify-center\">\r\n                                <PaymentSelect value={value} onChange={(val) => handleChange(colId, val)} />\r\n                            </div>\r\n                        ) : isAutorizacion ? (\r\n                            <div className=\"w-full h-full flex items-center justify-center\">\r\n                                <AuthorizationSelect value={value} onChange={(val) => handleChange(colId, val)} />\r\n                            </div>\r\n                        ) : (\r\n                            <input\r\n                                type={isNumeric ? \"number\" : \"text\"}\r\n                                className={cn(\r\n                                    \"ghost-row-input w-full bg-transparent border-none focus:outline-none focus:ring-1 focus:ring-blue-400 rounded text-base h-10 px-2 font-medium text-zinc-900 border border-zinc-100 shadow-sm\",\r\n                                    \"placeholder:text-zinc-300 placeholder:italic\",\r\n                                    error && \"bg-red-50 text-red-900 ring-1 ring-inset ring-red-500 placeholder:text-red-400\",\r\n                                    isSubmitting && \"opacity-50 cursor-wait\"\r\n                                )}\r\n                                placeholder={error ? error : getPlaceholder(colId)}\r\n                                value={value}\r\n                                onChange={(e) => handleChange(colId, e.target.value)}\r\n                                onBlur={(e) => handleBlur(colId, e.target.value)}\r\n                                onKeyDown={handleKeyDown}\r\n                                disabled={isSubmitting}\r\n                                title={error || `Ingrese ${getPlaceholder(colId)}`}\r\n                            />\r\n                        )}\r\n                    </td>\r\n                )\r\n            })}\r\n        </tr>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\components\\datagrid\\payment-select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\components\\datagrid\\status-select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\components\\login-button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\components\\providers.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\hooks\\use-current-user.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2670,2673],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2670,2673],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"prefer-const","severity":2,"message":"'sourceOfTruthIsUrl' is never reassigned. Use 'const' instead.","line":77,"column":17,"nodeType":"Identifier","messageId":"useConst","endLine":77,"endColumn":35,"fix":{"range":[3954,3988],"text":"const sourceOfTruthIsUrl = !!qUserId"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":121,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5692,5695],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5692,5695],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":122,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":122,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5754,5757],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5754,5757],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":123,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":123,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5818,5821],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5818,5821],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":147,"column":22,"nodeType":"Identifier","messageId":"unusedVar","endLine":147,"endColumn":23}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'qRole' and 'qUserId'. Either include them or remove the dependency array.","line":156,"column":8,"nodeType":"ArrayExpression","endLine":156,"endColumn":26,"suggestions":[{"desc":"Update the dependencies array to be: [urlKey, supabase, qUserId, qRole]","fix":{"range":[7325,7343],"text":"[urlKey, supabase, qUserId, qRole]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":5,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":1,"fixableWarningCount":0,"source":"\r\nimport { useEffect, useState, useMemo } from \"react\"\r\nimport { createClient } from \"@/utils/supabase/client\"\r\nimport { useSearchParams } from \"next/navigation\"\r\n\r\nexport type ViewMode = \"LAB\" | \"COM\" | \"ADMIN\"\r\n\r\nexport function useCurrentUser() {\r\n    const supabase = useMemo(() => createClient(), [])\r\n    const searchParams = useSearchParams()\r\n\r\n    // Stable key for URL changes to keep dependency array safe\r\n    const urlKey = searchParams.toString()\r\n\r\n    // Derived values from URL (Reactive because they depend on searchParams)\r\n    const qUserId = searchParams.get(\"userId\")\r\n    const qRole = searchParams.get(\"role\")?.toLowerCase() || null\r\n    const qCanWrite = searchParams.get(\"canWrite\") === \"true\"\r\n    const qIsAdmin = searchParams.get(\"isAdmin\") === \"true\"\r\n\r\n    const [role, setRole] = useState<string | null>(qRole)\r\n    const [loading, setLoading] = useState(true)\r\n    const [userId, setUserId] = useState<string | null>(qUserId)\r\n    const [needsAuth, setNeedsAuth] = useState(false)\r\n\r\n    const [allowedViews, setAllowedViews] = useState<ViewMode[]>(() => {\r\n        // Role-based mapping for known roles (before DB load)\r\n        const rNorm = (qRole || \"\").toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n\r\n        // Map role_ids to their expected views (based on database permissions)\r\n        const roleViewMap: Record<string, ViewMode[]> = {\r\n            'admin': ['LAB', 'COM', 'ADMIN'],           // Superadmin: all views\r\n            'administrativo': ['ADMIN'],                 // Administrativo: only admin view\r\n            'vendor': ['COM'],                           // Vendor: only commercial view\r\n            'laboratorio_lector': ['LAB'],               // Lab reader: only lab view\r\n            'laboratorio_tipificador': ['LAB']           // Lab tipificador: only lab view\r\n        }\r\n\r\n        // Use exact match first, then fall back to heuristics\r\n        if (roleViewMap[rNorm]) {\r\n            return roleViewMap[rNorm]\r\n        }\r\n\r\n        // Heuristic fallback for unknown roles\r\n        if (rNorm === 'admin' || qIsAdmin) return ['LAB', 'COM', 'ADMIN']\r\n        if (rNorm.includes('comercial') || rNorm.includes('vendor') || rNorm.includes('vendedor')) return ['COM']\r\n        if (rNorm.includes('laboratorio')) return ['LAB']\r\n\r\n        // Default: wait for DB permissions (show only the requested mode)\r\n        const qMode = searchParams.get(\"mode\")?.toUpperCase()\r\n        if (qMode === \"COMERCIAL\" || qMode === \"COM\") return ['COM']\r\n        if (qMode === \"ADMIN\") return ['ADMIN']\r\n        return ['LAB']  // Ultimate fallback\r\n    })\r\n\r\n    const [permissions, setPermissions] = useState<any>(() => {\r\n        // Initial permissions: minimal until DB load completes\r\n        // We only grant write if qCanWrite or qIsAdmin are explicitly true\r\n        const rNorm = (qRole || \"\").toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n        const isSuperAdmin = rNorm === 'admin' || qIsAdmin\r\n        const dynamicCanWrite = qCanWrite || isSuperAdmin\r\n\r\n        return {\r\n            laboratorio: { read: isSuperAdmin || rNorm.includes('laboratorio'), write: dynamicCanWrite && (isSuperAdmin || rNorm.includes('laboratorio')), delete: false },\r\n            programacion: { read: isSuperAdmin || rNorm.includes('laboratorio'), write: dynamicCanWrite && (isSuperAdmin || rNorm.includes('laboratorio')), delete: false },\r\n            comercial: { read: isSuperAdmin || rNorm.includes('comercial') || rNorm.includes('vendor') || rNorm.includes('vendedor'), write: dynamicCanWrite, delete: false },\r\n            administracion: { read: isSuperAdmin || rNorm === 'administrativo', write: dynamicCanWrite, delete: false }\r\n        }\r\n    })\r\n\r\n    useEffect(() => {\r\n        async function fetchIdentityAndPerms() {\r\n            setLoading(true)\r\n\r\n            // 1. Get User ID (either from URL or Supabase Session)\r\n            let currentUid = qUserId\r\n            let sourceOfTruthIsUrl = !!qUserId\r\n\r\n            if (!currentUid) {\r\n                const { data: { session } } = await supabase.auth.getSession()\r\n                if (session) {\r\n                    currentUid = session.user.id\r\n                    setUserId(currentUid)\r\n                } else {\r\n                    // NO USER DETECTED AT ALL\r\n                    setNeedsAuth(true)\r\n                    setLoading(false)\r\n                    return\r\n                }\r\n            } else {\r\n                setUserId(currentUid)\r\n                setNeedsAuth(false)\r\n            }\r\n\r\n            // 2. Sync basic identity state\r\n            if (qRole) setRole(qRole)\r\n\r\n            // 3. NO initial view calculation - wait for DB permissions\r\n            // (Initial views are set by useState based on role heuristics)\r\n\r\n\r\n            // 4. Fetch Profile & Permissions Matrix (silently handle 406 errors from FK join)\r\n            try {\r\n                const { data: profile, error: profileError } = await supabase\r\n                    .from(\"perfiles\")\r\n                    .select(\"role, role_definitions!fk_perfiles_role(permissions)\")\r\n                    .eq(\"id\", currentUid)\r\n                    .single()\r\n\r\n                // Silently ignore 406 errors (FK relation issues) - URL context is sufficient\r\n                if (profileError) {\r\n                    // Don't log - this is expected in Iframe context\r\n                    setLoading(false)\r\n                    return\r\n                }\r\n\r\n                if (profile) {\r\n                    const dbRole = profile.role?.toLowerCase()\r\n                    if (!sourceOfTruthIsUrl) setRole(dbRole)\r\n\r\n                    const roleDef = Array.isArray((profile as any).role_definitions)\r\n                        ? (profile as any).role_definitions[0]\r\n                        : (profile as any).role_definitions\r\n\r\n                    const dbPerms = roleDef?.permissions\r\n                    if (dbPerms && Object.keys(dbPerms).length > 0) {\r\n                        setPermissions(dbPerms)\r\n\r\n                        // Build allowed views strictly from database permissions\r\n                        const dbViews: ViewMode[] = []\r\n                        if (dbPerms.laboratorio?.read || dbPerms.programacion?.read) dbViews.push(\"LAB\")\r\n                        if (dbPerms.comercial?.read) dbViews.push(\"COM\")\r\n                        if (dbPerms.administracion?.read) dbViews.push(\"ADMIN\")\r\n\r\n                        // Special case: Only 'admin' (superadmin) gets all views unconditionally\r\n                        const dbRoleNorm = (dbRole || \"\").normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n                        const isSuperAdmin = dbRoleNorm === \"admin\" // Only exact 'admin' role\r\n\r\n                        if (isSuperAdmin) {\r\n                            setAllowedViews([\"LAB\", \"COM\", \"ADMIN\"])\r\n                        } else if (dbViews.length > 0) {\r\n                            setAllowedViews([...new Set(dbViews)])\r\n                        }\r\n                    }\r\n\r\n                }\r\n            } catch (e) {\r\n                // Fallback - Iframe running with URL context\r\n            } finally {\r\n                setLoading(false)\r\n            }\r\n        }\r\n\r\n        fetchIdentityAndPerms()\r\n        // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    }, [urlKey, supabase])\r\n\r\n    return {\r\n        userId,\r\n        role,\r\n        loading,\r\n        needsAuth,\r\n        allowedViews,\r\n        permissions,\r\n        getCanView: (mode: ViewMode) => allowedViews.includes(mode),\r\n        getCanWrite: (mode: ViewMode) => {\r\n            // Priority 1: URL explicit flags (for smooth Iframe experience)\r\n            if (qIsAdmin) return true\r\n            if (qCanWrite) return true\r\n\r\n            // Priority 2: Superadmin bypass (only exact 'admin' role)\r\n            const rNorm = (role || \"\").toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\")\r\n            if (rNorm === 'admin') return true\r\n\r\n            // Priority 3: Granular Matrix Permissions from Database\r\n            if (mode === \"LAB\") {\r\n                return permissions?.laboratorio?.write || permissions?.programacion?.write || false\r\n            }\r\n            if (mode === \"COM\") {\r\n                return permissions?.comercial?.write || false\r\n            }\r\n            if (mode === \"ADMIN\") {\r\n                return permissions?.administracion?.write || false\r\n            }\r\n            return false\r\n        }\r\n\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\hooks\\use-programacion-data.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used.","line":13,"column":49,"nodeType":"Identifier","messageId":"unusedVar","endLine":13,"endColumn":54},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'payload' is defined but never used.","line":37,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":37,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'payload' is defined but never used.","line":44,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":44,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'payload' is defined but never used.","line":51,"column":18,"nodeType":"Identifier","messageId":"unusedVar","endLine":51,"endColumn":25},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":107,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":107,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4565,4568],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4565,4568],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":147,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":147,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6019,6022],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6019,6022],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":153,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":153,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6517,6520],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6517,6520],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useCallback, useState, useMemo } from \"react\"\r\nimport { useQuery, useQueryClient } from \"@tanstack/react-query\"\r\nimport { createClient } from \"@/utils/supabase/client\"\r\nimport { ProgramacionServicio } from \"@/types/programacion\"\r\nimport { toast } from \"sonner\"\r\n\r\nexport function useProgramacionData() {\r\n    const supabase = useMemo(() => createClient(), [])\r\n    const queryClient = useQueryClient()\r\n    const [realtimeStatus, setRealtimeStatus] = useState<\"CONNECTING\" | \"SUBSCRIBED\" | \"CHANNEL_ERROR\" | \"TIMED_OUT\" | \"CLOSED\">(\"CONNECTING\")\r\n\r\n    // 1. Fetch Inicial (Carga los 2000 registros una vez)\r\n    const { data: programacion = [], isLoading, error } = useQuery({\r\n        queryKey: [\"programacion\"],\r\n        queryFn: async () => {\r\n            const { data, error } = await supabase\r\n                .from(\"cuadro_control\")\r\n                .select(\"*\")\r\n                .order(\"item_numero\", { ascending: true })\r\n\r\n            if (error) {\r\n                console.error(\"Error fetching data:\", error)\r\n                toast.error(\"Error al cargar datos\")\r\n                throw error\r\n            }\r\n            return data as ProgramacionServicio[]\r\n        },\r\n    })\r\n\r\n    // 2. Suscripci├│n Realtime (La magia para no dar F5)\r\n    useEffect(() => {\r\n        const channel = supabase\r\n            .channel(\"cuadro_control_changes\")\r\n            .on(\r\n                \"postgres_changes\",\r\n                { event: \"*\", schema: \"public\", table: \"programacion_lab\" },\r\n                (payload) => {\r\n                    queryClient.invalidateQueries({ queryKey: [\"programacion\"] })\r\n                }\r\n            )\r\n            .on(\r\n                \"postgres_changes\",\r\n                { event: \"*\", schema: \"public\", table: \"programacion_comercial\" },\r\n                (payload) => {\r\n                    queryClient.invalidateQueries({ queryKey: [\"programacion\"] })\r\n                }\r\n            )\r\n            .on(\r\n                \"postgres_changes\",\r\n                { event: \"*\", schema: \"public\", table: \"programacion_administracion\" },\r\n                (payload) => {\r\n                    queryClient.invalidateQueries({ queryKey: [\"programacion\"] })\r\n                }\r\n            )\r\n            .subscribe((status) => {\r\n                setRealtimeStatus(status)\r\n                if (status === \"CHANNEL_ERROR\") {\r\n                    toast.error(\"Error de conexi├│n en tiempo real\")\r\n                }\r\n            })\r\n\r\n        // Limpieza al salir de la p├ígina\r\n        return () => {\r\n            supabase.removeChannel(channel)\r\n        }\r\n    }, [queryClient, supabase])\r\n\r\n    const updateField = useCallback(async (rowId: string, field: string, value: unknown) => {\r\n        // 1. Optimistic Update in Cache\r\n        queryClient.setQueryData([\"programacion\"], (oldData: ProgramacionServicio[] = []) => {\r\n            return oldData.map(row => row.id === rowId ? { ...row, [field]: value } : row)\r\n        })\r\n\r\n        try {\r\n            // Route update to the correct table\r\n            const commercialFields = ['fecha_solicitud_com', 'fecha_entrega_com', 'evidencia_solicitud_envio', 'dias_atraso_envio_coti', 'motivo_dias_atraso_com']\r\n            const adminFields = ['numero_factura', 'estado_pago', 'estado_autorizar', 'nota_admin']\r\n\r\n            let targetTable = \"programacion_lab\"\r\n            let idField = \"id\"\r\n\r\n            if (commercialFields.includes(field)) {\r\n                targetTable = \"programacion_comercial\"\r\n                idField = \"programacion_id\"\r\n            } else if (adminFields.includes(field)) {\r\n                targetTable = \"programacion_administracion\"\r\n                idField = \"programacion_id\"\r\n            }\r\n\r\n            const { error } = await supabase\r\n                .from(targetTable)\r\n                .update({ [field]: value, updated_at: new Date().toISOString() })\r\n                .eq(idField, rowId)\r\n\r\n            if (error) throw error\r\n        } catch (error) {\r\n            console.error(\"Update failed:\", error)\r\n            toast.error(\"Error al guardar\")\r\n            // Rollback could be implemented by refetching or saving previous state, \r\n            // but for simple text edits, just invalidating usually works enough or letting user retry\r\n            queryClient.invalidateQueries({ queryKey: [\"programacion\"] })\r\n        }\r\n    }, [queryClient, supabase])\r\n\r\n    const insertRow = useCallback(async (newRow: Partial<ProgramacionServicio>) => {\r\n        // Prepare data for programacion_lab (base table)\r\n        const labData: any = {\r\n            ...newRow,\r\n            estado_trabajo: newRow.estado_trabajo || \"PENDIENTE\",\r\n        }\r\n\r\n        // Remove fields that don't belong to programacion_lab\r\n        delete labData.item_numero // Auto-generated\r\n        delete labData.fecha_solicitud_com\r\n        delete labData.fecha_entrega_com\r\n        delete labData.evidencia_solicitud_envio\r\n        delete labData.motivo_dias_atraso_com\r\n        delete labData.numero_factura\r\n        delete labData.estado_pago\r\n        delete labData.estado_autorizar\r\n        delete labData.nota_admin\r\n        delete labData.dias_atraso_envio_coti // Computed field\r\n\r\n        // Remove undefined/null values to avoid sending them to Supabase\r\n        Object.keys(labData).forEach(key => {\r\n            if (labData[key] === undefined || labData[key] === null || labData[key] === '') {\r\n                delete labData[key]\r\n            }\r\n        })\r\n\r\n        const { data: insertedData, error: labError } = await supabase\r\n            .from(\"programacion_lab\")\r\n            .insert(labData)\r\n            .select()\r\n            .single()\r\n\r\n        if (labError) {\r\n            console.error(\"Insert lab failed:\", labError)\r\n            toast.error(\"Error al crear registro base\")\r\n            throw labError\r\n        }\r\n\r\n        if (insertedData) {\r\n            const rowId = insertedData.id\r\n\r\n            // Check if we need to update extension tables\r\n            const commercialData: any = {}\r\n            if (newRow.fecha_solicitud_com) commercialData.fecha_solicitud_com = newRow.fecha_solicitud_com\r\n            if (newRow.fecha_entrega_com) commercialData.fecha_entrega_com = newRow.fecha_entrega_com\r\n            if (newRow.evidencia_solicitud_envio) commercialData.evidencia_solicitud_envio = newRow.evidencia_solicitud_envio\r\n            if (newRow.motivo_dias_atraso_com) commercialData.motivo_dias_atraso_com = newRow.motivo_dias_atraso_com\r\n\r\n            const adminData: any = {}\r\n            if (newRow.numero_factura) adminData.numero_factura = newRow.numero_factura\r\n            if (newRow.estado_pago) adminData.estado_pago = newRow.estado_pago\r\n            if (newRow.estado_autorizar) adminData.estado_autorizar = newRow.estado_autorizar\r\n            if (newRow.nota_admin) adminData.nota_admin = newRow.nota_admin\r\n\r\n            if (Object.keys(commercialData).length > 0) {\r\n                await supabase.from(\"programacion_comercial\").update(commercialData).eq(\"programacion_id\", rowId)\r\n            }\r\n            if (Object.keys(adminData).length > 0) {\r\n                await supabase.from(\"programacion_administracion\").update(adminData).eq(\"programacion_id\", rowId)\r\n            }\r\n\r\n            // The views will reload via realtime or cache invalidation\r\n            queryClient.invalidateQueries({ queryKey: [\"programacion\"] })\r\n        }\r\n    }, [queryClient, supabase])\r\n\r\n    const exportToExcel = useCallback(async (items: ProgramacionServicio[]) => {\r\n        const toastId = toast.loading(\"Generando Excel...\")\r\n        try {\r\n            const apiUrl = process.env.NEXT_PUBLIC_API_URL || \"http://localhost:8000\"\r\n            const response = await fetch(`${apiUrl}/programacion/export`, {\r\n                method: \"POST\",\r\n                headers: {\r\n                    \"Content-Type\": \"application/json\",\r\n                },\r\n                body: JSON.stringify({ items }),\r\n            })\r\n\r\n            if (!response.ok) {\r\n                const errorText = await response.text()\r\n                throw new Error(errorText || \"Error al exportar\")\r\n            }\r\n\r\n            const blob = await response.blob()\r\n            const url = window.URL.createObjectURL(blob)\r\n            const a = document.createElement(\"a\")\r\n            a.href = url\r\n            a.download = `Programacion_${new Date().toISOString().split(\"T\")[0]}.xlsx`\r\n            document.body.appendChild(a)\r\n            a.click()\r\n            window.URL.revokeObjectURL(url)\r\n            document.body.removeChild(a)\r\n            toast.success(\"Excel descargado correctamente\", { id: toastId })\r\n        } catch (error) {\r\n            console.error(\"Export error:\", error)\r\n            toast.error(\"Error al generar Excel\", { id: toastId })\r\n        }\r\n    }, [])\r\n\r\n    return {\r\n        data: programacion,\r\n        isLoading,\r\n        realtimeStatus,\r\n        updateField,\r\n        insertRow,\r\n        exportToExcel\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\services\\external-api.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ProgramacionServicio' is defined but never used.","line":1,"column":10,"nodeType":"Identifier","messageId":"unusedVar","endLine":1,"endColumn":30,"suggestions":[{"messageId":"removeUnusedImportDeclaration","data":{"varName":"ProgramacionServicio"},"fix":{"range":[0,59],"text":""},"desc":"Remove unused import declaration."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ProgramacionServicio } from \"@/types/programacion\"\r\n\r\nconst API_BASE_URL = \"https://api.geofal.com.pe/v1\"\r\n\r\nclass ProgramacionApiError extends Error {\r\n    constructor(public message: string, public status: number) {\r\n        super(message)\r\n    }\r\n}\r\n\r\nasync function fetchWithAuth(endpoint: string, options: RequestInit = {}) {\r\n    // In a real app, retrieve token from Supabase auth or storage\r\n    const token = \"mock-token-for-now\"\r\n\r\n    const res = await fetch(`${API_BASE_URL}${endpoint}`, {\r\n        ...options,\r\n        headers: {\r\n            \"Content-Type\": \"application/json\",\r\n            \"Authorization\": `Bearer ${token}`,\r\n            ...options.headers,\r\n        },\r\n    })\r\n\r\n    if (!res.ok) {\r\n        throw new ProgramacionApiError(`API Error: ${res.statusText}`, res.status)\r\n    }\r\n\r\n    return res.json()\r\n}\r\n\r\nexport const externalApi = {\r\n    /**\r\n     * Update status with business logic side-effects\r\n     */\r\n    updateEstado: async (id: string, newEstado: string, userId: string) => {\r\n        return fetchWithAuth(`/programacion/${id}/estado`, {\r\n            method: \"PATCH\",\r\n            body: JSON.stringify({ estado: newEstado, userId }),\r\n        })\r\n    },\r\n\r\n    /**\r\n     * Close a period (complex logic)\r\n     */\r\n    closePeriodo: async (periodoId: string) => {\r\n        return fetchWithAuth(`/periodos/${periodoId}/cerrar`, {\r\n            method: \"POST\",\r\n        })\r\n    },\r\n\r\n    /**\r\n     * Validate a specific workflow transition\r\n     */\r\n    validateTramite: async (id: string, action: string) => {\r\n        return fetchWithAuth(`/programacion/${id}/validate`, {\r\n            method: \"POST\",\r\n            body: JSON.stringify({ action }),\r\n        })\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\types\\programacion.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\Lenovo\\Documents\\crmnew\\programacion-crm\\src\\utils\\supabase\\client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
